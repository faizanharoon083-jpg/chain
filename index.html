<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>üí± Auto-Trading Bot</title>
    <!-- Favicon/Logo -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí±</text></svg>">

    <!-- PWA Manifest Link (Generated via JS) -->
    <link rel="manifest" id="pwa-manifest-link">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TradingView Widget API -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <!-- QR Code Library for Deposit Addresses and Google Auth -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --accent: #f0b90b;
        }
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: 'Inter', sans-serif;
        }
        .page { display: none; }
        .tab-active { color: var(--accent); }
        .tab-active svg { fill: var(--accent); }
        .coin-row:hover { background: rgba(255, 255, 255, 0.05); }
        .tv-container { border-radius: 8px; overflow: hidden; background: #0b0f14; border: 1px solid rgba(255, 255, 255, 0.05); }
        .scrollable-content { max-height: 400px; overflow-y: auto; }
        .logo-text { font-size: 24px; }
        /* CoinStats Landing Page Style Overrides */
        #landingPage { background: linear-gradient(180deg, #10151c 0%, #000000 100%); }
        .coinstats-card { background-color: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); }
        /* Custom PWA Install Prompt Styling */
        .install-prompt {
            position: fixed;
            bottom: 6rem; /* Above footer */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #1f2937;
            border: 2px solid var(--accent);
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="bg-black text-white font-sans min-h-screen">

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-90 z-[9999] flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div id="loadingText" class="mt-4 text-sm font-medium text-yellow-500">Processing...</div>
        </div>
    </div>

    <!-- Global Message Modal (Replaces alert/confirm) -->
    <div id="globalModal" class="fixed inset-0 bg-black bg-opacity-70 z-[9998] flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm border border-gray-700 shadow-xl">
            <h3 id="modalTitle" class="text-lg font-semibold mb-3 text-yellow-400">Message</h3>
            <p id="modalBody" class="text-sm text-gray-200 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalConfirm" class="px-4 py-2 bg-yellow-500 text-black rounded-md font-semibold text-sm hover:bg-yellow-600">OK</button>
            </div>
        </div>
    </div>

    <!-- ===== HEADER (Post-Login) ===== -->
    <header id="appHeader" class="flex items-center justify-between px-4 py-3 border-b border-gray-800 sticky top-0 bg-black z-20 hidden">
        <!-- Left: App Logo -->
        <div class="flex items-center gap-3">
            <div class="logo-text">üí±</div>
            <div class="text-sm font-semibold">Auto-Trading Bot</div>
        </div>

        <!-- Center: Search -->
        <div class="flex-1 px-3">
            <input id="globalSearch" type="search" placeholder="Search coins, pairs or features" class="w-full bg-gray-900 text-sm px-3 py-2 rounded-md border border-gray-700 focus:outline-none focus:border-yellow-500" />
            <!-- Search results panel -->
            <div id="searchPanel" class="hidden absolute left-0 right-0 mx-auto mt-2 w-11/12 max-w-sm bg-gray-900 border border-gray-800 rounded-md shadow-xl text-sm z-30">
                <div id="searchResults" class="p-2 scrollable-content max-h-56"></div>
            </div>
        </div>

        <!-- Right: Notifications, More -->
        <div class="flex items-center gap-3 ml-3">
            <!-- Notifications -->
            <button id="notifBtn" title="Notifications" class="p-1" onclick="showPage('notificationsPage')">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-9.33-4.95" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.5 19a2.5 2.5 0 005 0" />
                </svg>
            </button>

            <!-- MORE dropdown -->
            <div class="relative">
                <button id="moreBtn" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="5" r="1.5" />
                        <circle cx="12" cy="12" r="1.5" />
                        <circle cx="12" cy="19" r="1.5" />
                    </svg>
                </button>

                <div id="moreMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-900 border border-gray-800 rounded-md shadow-lg text-sm z-40">
                    <a href="#" class="block px-4 py-2 hover:bg-gray-800" onclick="showPage('walletDetailsPage'); closeMoreMenu()">Connected Wallet</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-800" onclick="showPage('settingsPage'); closeMoreMenu()">Settings</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-800" onclick="showPage('supportPage'); closeMoreMenu()">Support</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-800" onclick="handleCloseAccount(); closeMoreMenu()">Close Account</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-800 text-red-400" id="disconnectBtn" onclick="handleDisconnect(); closeMoreMenu()">Disconnect</a>
                </div>
            </div>
        </div>
    </header>

    <!-- ===== MAIN SPA PAGES CONTAINER ===== -->
    <main id="main" class="pb-20"> <!-- reserve footer height -->

    <!-- PWA Install Prompt (Hidden by default) -->
    <div id="installPromptContainer" class="hidden">
        <div class="install-prompt">
            <h3 class="text-xl font-bold">Install App</h3>
            <p class="text-sm text-gray-300 mt-2">Install Blockchain Auto-Trading Bot for the best experience!</p>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button class="px-4 py-2 bg-yellow-500 text-black rounded-md font-semibold text-sm hover:bg-yellow-600" id="pwaInstallNow"> Install Now </button>
                <button class="px-4 py-2 bg-gray-700 text-white rounded-md font-semibold text-sm hover:bg-gray-600" id="pwaInstallLater"> Maybe Later </button>
            </div>
        </div>
    </div>

    <!-- 1. LANDING PAGE (CoinStats Style) -->
    <section id="landingPage" class="page min-h-screen pt-12 p-4 text-center">
        <!-- Header -->
        <div class="flex items-center justify-between mx-auto max-w-4xl mb-12">
            <div class="logo-text text-yellow-500">üí± <span class="text-white font-bold ml-2">Auto-Trading Bot</span></div>
            <div class="space-x-4 flex items-center">
                <!-- More Options Panel Button -->
                <div class="relative">
                    <button id="landingMoreBtn" class="text-white p-2 rounded-full hover:bg-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <div id="landingMoreMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-900 border border-gray-800 rounded-md shadow-lg text-sm z-40">
                        <a href="#" class="block px-4 py-3 hover:bg-gray-800" onclick="showPage('walletConnectorPage'); closeLandingMoreMenu();">Connect Portfolio</a>
                        <a href="#" class="block px-4 py-3 hover:bg-gray-800" onclick="showPage('loginIdPage'); closeLandingMoreMenu();">Login ID</a>
                        <a href="#" class="block px-4 py-3 hover:bg-gray-800" onclick="showPage('supportPage'); closeLandingMoreMenu();">Support</a>
                        <a href="#" class="block px-4 py-3 hover:bg-gray-800" onclick="showPage('walletConnectorPage'); closeLandingMoreMenu();">Connect Wallet</a>
                        <a href="#" class="block px-4 py-3 hover:bg-gray-800 text-yellow-500" onclick="showPage('walletConnectorPage'); closeLandingMoreMenu();">Start Free Trail</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="max-w-3xl mx-auto">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-white leading-tight">
                Automated <span class="text-yellow-500">Blockchain Trading</span> System
            </h1>
            <p class="text-lg text-gray-400 mb-8">
                Harness the power of AI to execute high-frequency, profitable trades across multiple crypto exchanges, 24/7. Your secure, smart, and fully decentralized portfolio manager.
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-12">
                <button class="px-8 py-3 bg-yellow-500 text-black font-bold rounded-full text-lg hover:bg-yellow-600 transition-colors" onclick="showPage('walletConnectorPage')">Start Free Trail</button>
                <button id="installAppBtn" class="px-8 py-3 bg-gray-700 text-white font-semibold rounded-full text-lg hover:bg-gray-600 transition-colors">Get Mobile App</button>
            </div>
        </div>

        <!-- Market Overview (Live Prices Updates) -->
        <div class="max-w-6xl mx-auto mt-12">
            <h2 class="text-2xl font-bold mb-6 text-left">Live Market Overview</h2>
            <div id="landingMarketOverview" class="bg-gray-900 bg-opacity-70 p-4 rounded-xl shadow-2xl border border-gray-800 overflow-x-auto">
                <!-- Data will be loaded here by JavaScript -->
                <div class="text-gray-400 text-sm">Loading top coins...</div>
            </div>
        </div>

        <!-- Language Selector (Mock) -->
        <div class="text-center mt-12 text-sm text-gray-500 space-x-3">
            <a href="#" class="hover:text-white">English</a>
            <a href="#" class="hover:text-white">Espa√±ol</a>
            <a href="#" class="hover:text-white">Deutsch</a>
            <a href="#" class="hover:text-white">Fran√ßais</a>
        </div>
    </section>

    <!-- 2. WALLET CONNECTOR PAGE (Web3 Style) -->
    <section id="walletConnectorPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Connect Your Wallet</h2>
        <p class="text-sm text-gray-400 text-center mb-6">Select a method to securely connect your decentralized portfolio.</p>

        <!-- Wallet Connect Options -->
        <div class="space-y-4">
            <!-- Multi-Wallet/Mobile Connect -->
            <button class="w-full flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-700 transition-colors" onclick="handleWeb3Connect()">
                <span class="font-semibold text-lg">WalletConnect (Mobile/QR)</span>
                <svg class="w-6 h-6 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"/></svg>
            </button>
            
            <!-- Manual Connection Form -->
            <div class="p-5 bg-gray-800 rounded-xl border border-gray-700">
                <h3 class="font-semibold mb-3">Manual Connection (Address)</h3>
                <input id="manualWalletAddress" type="text" placeholder="Enter wallet address (e.g., 0x...)" class="w-full bg-gray-900 text-sm px-4 py-3 rounded-md border border-gray-700 focus:outline-none focus:border-yellow-500 mb-4" />
                <button class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="handleManualConnect()">Connect Wallet</button>
                <p class="text-xs text-gray-500 mt-3">Supports BTC, ETH, BNB, Tron addresses.</p>
            </div>
            
            <!-- Multi-Chain Network Selector (Mock) -->
            <div class="p-5 bg-gray-800 rounded-xl border border-gray-700">
                <h3 class="font-semibold mb-3">Chain Network Selection</h3>
                <select class="w-full bg-gray-900 text-sm px-4 py-3 rounded-md border border-gray-700 focus:outline-none focus:border-yellow-500">
                    <option>Ethereum Mainnet (ERC-20)</option>
                    <option>BNB Smart Chain (BEP20)</option>
                    <option>Bitcoin</option>
                    <option>Tron (TRC-20)</option>
                </select>
            </div>
        </div>

        <button class="mt-8 text-sm text-gray-500 hover:text-white" onclick="showPage('landingPage')">‚Üê Back to Landing Page</button>
    </section>

    <!-- 3. LOGIN ID PAGE -->
    <section id="loginIdPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Login with Wallet ID</h2>
        <p class="text-sm text-gray-400 text-center mb-6">Enter your 10-digit Wallet Account ID to access your portfolio.</p>

        <div class="p-5 bg-gray-800 rounded-xl border border-gray-700">
            <input id="loginAccountId" type="text" placeholder="Enter 10-digit Account ID" class="w-full bg-gray-900 text-sm px-4 py-3 rounded-md border border-gray-700 focus:outline-none focus:border-yellow-500 mb-4" maxlength="10" />
            <button class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="handleLoginId()">Confirm</button>
        </div>

        <button class="mt-8 text-sm text-gray-500 hover:text-white" onclick="showPage('landingPage')">‚Üê Back to Landing Page</button>
    </section>

<!-- ===============================
     4. HOME PAGE (Binance Style)
================================ -->
<section id="home" class="page p-0 bg-black text-white">

    <!-- Notification Banner -->
    <div id="dailyNotification" class="hidden sticky top-0 z-20 bg-yellow-400 text-black px-3 py-2 flex justify-between items-center text-xs font-medium">
        <span id="notifMessage">üî• Daily Market Update</span>
        <button onclick="hideNotification()" class="text-lg font-bold">&times;</button>
    </div>

    <!-- Wallet Overview Card -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-lg hover:shadow-yellow-400/20 transition">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-xs text-gray-400">Wallet ID</div>
                    <div id="homeWalletId" class="text-base font-semibold">N/A</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400">Total Balance</div>
                    <div id="totalBalance" class="text-2xl font-bold">$0.00</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex justify-between gap-3 mt-2">
                <button class="flex-1 flex flex-col items-center py-2 rounded-xl bg-gray-800 hover:bg-gray-700 transition" onclick="showPage('depositPage')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span class="text-xs mt-1">Deposit</span>
                </button>
                <button class="flex-1 flex flex-col items-center py-2 rounded-xl bg-gray-800 hover:bg-gray-700 transition" onclick="handleSwap()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 17h16"/>
                    </svg>
                    <span class="text-xs mt-1">Swap</span>
                </button>
                <button class="flex-1 flex flex-col items-center py-2 rounded-xl bg-gray-800 hover:bg-gray-700 transition" onclick="showWithdrawalSelect()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V6m0 0l-7 7m7-7l7 7"/>
                    </svg>
                    <span class="text-xs mt-1">Withdraw</span>
                </button>
                <button class="flex-1 flex flex-col items-center py-2 rounded-xl bg-gray-800 hover:bg-gray-700 transition" onclick="showPage('tradePage')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                    <span class="text-xs mt-1">Earn</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Token Holdings -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-lg">
            <h3 class="font-semibold mb-3">Token Holdings</h3>
            <div class="text-xs text-gray-400 mb-3">Total Value: <span id="tokenHoldingsValue" class="text-white">$0.00</span></div>
            
            <div id="tokenHoldingsSection" class="space-y-3">
                <!-- Example coin row -->
                <div class="flex items-center justify-between py-2 px-2 rounded-lg hover:bg-gray-800 transition">
                    <div class="flex items-center gap-3">
                        <img src="https://assets.coingecko.com/coins/images/325/small/Tether-logo.png" class="w-7 h-7 rounded-full" alt="USDT" />
                        <div>
                            <div class="font-semibold text-sm">Tether USD (USDT)</div>
                            <div id="usdtPrice" class="text-xs text-gray-400">$0.00</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="usdtBalance" class="font-semibold text-sm">0.00 USDT</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Chart -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-lg">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-semibold">BTC/USDT Performance</h3>
                <span class="text-xs text-gray-400">Live Chart</span>
            </div>
            <div class="tv-container" id="tvchart" style="height:300px;"></div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-lg">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Recent Activities</h3>
                <button class="text-yellow-500 text-xs" onclick="showPage('transactionsPage')">View All</button>
            </div>
            <div id="activityList" class="space-y-2 text-xs max-h-40 overflow-y-auto">
                <div class="text-gray-500">No recent activities.</div>
            </div>
        </div>
    </div>

    <!-- Top Coins (Market Movers) -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-lg">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Top Coins (24h)</h3>
                <button id="refreshMarkets" class="text-xs text-gray-400 hover:text-white" onclick="fetchMarketData()">‚Üª Refresh</button>
            </div>
            <div id="topCoinsList" class="space-y-2 text-sm">
                <div class="text-gray-500">Loading market data...</div>
            </div>
        </div>
    </div>

</section>
    
<!-- ===============================
     5. MARKET PAGE (Binance Mobile Market Style)
================================= -->
<section id="marketPage" class="page bg-black text-white min-h-screen">

    <!-- Page Header -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-800">
        <h2 class="text-xl font-bold">Markets</h2>
        <button id="searchMarketBtn" class="p-2 bg-gray-900 rounded-lg hover:bg-gray-800 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
        </button>
    </div>

    <!-- Market Tabs (Spot / Futures / Favorites) -->
    <div class="flex justify-around text-sm font-medium border-b border-gray-800 bg-gray-900">
        <button class="flex-1 py-3 text-yellow-400 border-b-2 border-yellow-400">Spot</button>
        <button class="flex-1 py-3 text-gray-400 hover:text-white">Futures</button>
        <button class="flex-1 py-3 text-gray-400 hover:text-white">Favorites</button>
    </div>

    <!-- Gainers & Losers -->
    <div class="p-4">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow mb-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Gainers & Losers (24h)</h3>
                <div class="flex gap-2 text-xs">
                    <button id="topGainersBtn" class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-500">Gainers</button>
                    <button id="topLosersBtn" class="px-3 py-1 rounded-md bg-red-600 hover:bg-red-500">Losers</button>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <div id="gainersList" class="space-y-2 text-xs text-green-400">Loading top gainers...</div>
                <div id="losersList" class="space-y-2 text-xs text-red-400 hidden">Loading top losers...</div>
            </div>
        </div>

        <!-- All Coins List -->
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">All Coins</h3>
                <button id="refreshCoins" class="text-xs text-gray-400 hover:text-white">‚Üª Refresh</button>
            </div>
            <input type="text" id="marketSearch" placeholder="Search coins or pairs" 
                   class="w-full mb-3 px-3 py-2 rounded-md bg-gray-800 text-sm placeholder-gray-400 focus:outline-none" />

            <div id="marketCoinList" class="divide-y divide-gray-800 max-h-96 overflow-y-auto">
                <!-- Example Coin Row -->
                <div class="flex items-center justify-between py-2 px-1 hover:bg-gray-800 transition cursor-pointer" onclick="showMarketCoinChart('BINANCE:BTCUSDT')">
                    <div class="flex items-center gap-3">
                        <img src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png" alt="BTC" class="w-6 h-6 rounded-full">
                        <div>
                            <div class="font-semibold text-sm">BTC/USDT</div>
                            <div class="text-xs text-gray-400">Bitcoin</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-sm">$27,450</div>
                        <div class="text-xs text-green-400">+2.5%</div>
                    </div>
                </div>
                <div class="flex items-center justify-between py-2 px-1 hover:bg-gray-800 transition cursor-pointer" onclick="showMarketCoinChart('BINANCE:ETHUSDT')">
                    <div class="flex items-center gap-3">
                        <img src="https://assets.coingecko.com/coins/images/279/small/ethereum.png" alt="ETH" class="w-6 h-6 rounded-full">
                        <div>
                            <div class="font-semibold text-sm">ETH/USDT</div>
                            <div class="text-xs text-gray-400">Ethereum</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-sm">$1,720</div>
                        <div class="text-xs text-red-400">-1.2%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coin Detail Chart -->
    <div id="marketCoinChartContainer" class="p-4 hidden">
        <div class="bg-gray-900 rounded-2xl p-2 border border-gray-800 shadow">
            <div id="marketCoinChart" style="height:300px;" class="w-full"></div>
        </div>
    </div>
</section>


<!-- ======================================================= -->
<!-- 6. TRADE PAGE (TradingView + Live Projection + SVG Labels) -->
<!-- ======================================================= -->
<section id="tradePage" class="page p-4 bg-black text-white min-h-screen">
  <h2 class="text-2xl font-bold mb-4">Trade</h2>
  <button class="mt-4 text-sm text-gray-400 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>

  <!-- Trade Summary -->
  <div class="mb-4 bg-gray-900 rounded-xl p-4 border border-gray-800">
    <h3 class="font-semibold mb-3">Trade Account Summary</h3>

    <ul class="space-y-2 text-sm">
      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <!-- Wallet SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M4 5h16a1 1 0 011 1v3H3V6a1 1 0 011-1zm-1 6h18v7a1 1 0 01-1 1H4a1 1 0 01-1-1v-7z" />
          </svg>
          Total Trade Balance:
        </div>
        <span id="tradeBalance" class="font-semibold">$0.00</span>
      </li>

      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <!-- Growth SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M4 12l4-4 4 4 8-8M12 12v8m8-8v8" />
          </svg>
          Total Generated Returns:
        </div>
        <span id="tradeReturns" class="text-green-400 font-semibold">$0.00</span>
      </li>

      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <!-- Percent SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M19 5L5 19M9 5a2 2 0 110 4 2 2 0 010-4zm6 10a2 2 0 110 4 2 2 0 010-4z" />
          </svg>
          Total Percentage Returns:
        </div>
        <span id="tradePercentage" class="text-green-400 font-semibold">0%</span>
      </li>

      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <!-- Coins SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M12 8c-4.418 0-8 1.79-8 4v4c0 2.21 3.582 4 8 4s8-1.79 8-4v-4c0-2.21-3.582-4-8-4zM4 12v4m16-4v4" />
          </svg>
          Total Earnings:
        </div>
        <span id="totalEarningsValue" class="text-green-400 font-semibold">$0.00</span>
      </li>
    </ul>

    <div id="tradeStatus" class="text-center text-sm mt-4 text-yellow-400">No active trade.</div>

    <div class="flex gap-3 mt-4">
      <button class="flex-1 px-3 py-2 bg-yellow-500 text-black rounded font-semibold text-sm hover:bg-yellow-600" onclick="showTradeDepositSelect()">Deposit</button>
      <button class="flex-1 px-3 py-2 bg-blue-500 text-white rounded font-semibold text-sm hover:bg-blue-600" onclick="showPage('viewEarningsPage')">View Earnings</button>
    </div>
  </div>

  <!-- Tabbed Chart View -->
  <div class="mb-4">
    <div class="flex mb-3 border-b border-gray-700">
      <button id="liveTabBtn" class="tab-btn px-4 py-2 text-sm font-semibold border-b-2 border-yellow-500" onclick="switchTradeTab('live')">Live Chart</button>
      <button id="projectionTabBtn" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white" onclick="switchTradeTab('projection')">Projection</button>
    </div>
    <div id="tradeLiveChart" class="tv-container w-full" style="height:350px;"></div>
    <canvas id="tradeProjectionChart" class="hidden w-full h-[350px]"></canvas>
  </div>

  <!-- Place Trade Button -->
  <button id="placeTradeBtn" class="w-full px-4 py-3 bg-green-500 text-black font-semibold rounded-md text-lg hover:bg-green-600 transition-colors" onclick="showTradeOrderPage()">Place Trade</button>

  <!-- Active Trade Details -->
  <div id="activeTradeDetails" class="mt-4 bg-gray-800 rounded-xl p-4 border border-gray-700 hidden">
    <h3 class="font-semibold mb-2 text-yellow-500">Active Trade</h3>
    <p class="text-sm">Asset: <span id="tradeAsset"></span></p>
    <p class="text-sm">Duration: <span id="tradeDuration"></span></p>
    <p class="text-sm">Ends In: <span id="tradeCountdownActive" class="font-bold"></span></p>
  </div>
</section>

<!-- ======================================================= -->
<!-- VIEW EARNINGS PAGE (Live Synced + SVG Labels + New Sections) -->
<!-- ======================================================= -->
<section id="viewEarningsPage" class="page p-4 bg-black text-white min-h-screen">
  <h2 class="text-2xl font-bold mb-4">Trade Earnings</h2>

  <button class="w-full text-sm text-gray-400 hover:text-white text-left"
      onclick="showPage('tradePage')">‚ÜêBack</button>

  <!-- Earnings Overview -->
  <div class="mb-4 bg-gray-900 rounded-xl p-4 border border-gray-800">
    <h3 class="font-semibold mb-3">Earnings Overview</h3>
    <ul class="space-y-3 text-sm">

      <!-- Total Earnings -->
      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M12 8c-4.418 0-8 1.79-8 4s3.582 4 8 4 8-1.79 8-4-3.582-4-8-4zM4 12v4m16-4v4" />
          </svg>
          Total Earnings:
        </div>
        <span id="totalEarningsValue" class="text-green-400 font-semibold">$0.00</span>
      </li>

      <!-- Total Percentage Returns -->
      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M19 5L5 19M9 5a2 2 0 110 4 2 2 0 010-4zm6 10a2 2 0 110 4 2 2 0 010-4z" />
          </svg>
          Total Percentage Returns:
        </div>
        <span id="totalPercentageReturns" class="text-green-400 font-semibold">0%</span>
      </li>

    
      <!-- Returns -->
      <li class="flex justify-between items-center">
        <div class="flex items-center gap-2 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M4 12l4-4 4 4 8-8M12 12v8m8-8v8" />
          </svg>
          Returns:
        </div>
        <span id="totalEarningsValue" class="text-green-400 font-semibold">$0.00</span>
      </li>

      <!-- Overall Earnings -->
      <li class="flex justify-between items-center border-t border-gray-800 pt-2 mt-2">
        <div class="flex items-center gap-2 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M12 8c-4.418 0-8 1.79-8 4v4c0 2.21 3.582 4 8 4s8-1.79 8-4v-4c0-2.21-3.582-4-8-4z" />
          </svg>
          Overall Earnings:
        </div>
        <span id="totalEarningsValue" class="text-green-400 font-semibold">$0.00</span>
      </li>

    </ul>
  </div>

  <!-- Active Trade Details -->
  <div id="viewEarningsTradeDetails" class="bg-gray-900 rounded-xl p-4 border border-gray-800 mb-4 text-sm">
    <h3 class="font-semibold mb-2 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      Active Trade Details
    </h3>
    <p class="text-gray-400">
      <span class="text-white font-semibold" id="viewEarningsTradeDetails">Current trade details...</span>
    </p>
  </div>

  <!-- Tabbed Chart View -->
  <div class="mb-6">
    <div class="flex mb-3 border-b border-gray-700">
      <button class="tab-btn px-4 py-2 text-sm font-semibold border-b-2 border-yellow-500" onclick="switchEarningsTab('live')">
        Live Chart
      </button>
      <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white" onclick="switchEarningsTab('projection')">
        Projection
      </button>
    </div>

    <!-- TradingView Live Chart -->
    <div id="earningsLiveChart" class="tv-container w-full" style="height:350px;"></div>

    <!-- Projection Chart -->
    <canvas id="earningsProjectionChart" class="hidden w-full h-[350px]"></canvas>
  </div>

  <!-- Action Buttons -->
  <div class="space-y-3">
    <button class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors"
      onclick="showTransferModal()">Transfer</button>

</section>

<!-- ======================================================= -->
<!-- TRANSFER MODAL -->
<!-- ======================================================= -->
<div id="transferModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-end hidden">
  <div class="w-full bg-gray-900 rounded-t-xl p-6 border-t border-gray-700">
    <h3 class="text-xl font-bold mb-4">Transfer Funds</h3>
    <div class="space-y-4">
      <select id="transferDirection" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500">
        <option value="tradeToMain">Transfer from Trade Account to Main Wallet</option>
        <option value="mainToTrade">Transfer from Main Wallet to Trade Account</option>
      </select>
      <input id="transferAmountInput" type="number" step="0.01" min="0" placeholder="Enter amount to transfer" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" />
    </div>
    <button class="w-full mt-6 px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="handleTransfer()">Transfer</button>
    <button class="w-full mt-3 px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600" onclick="hideTransferModal()">Cancel</button>
  </div>
</div>

<!-- ======================================================= -->
<!-- TRADE ORDER PAGE -->
<!-- ======================================================= -->
<section id="tradeOrderPage" class="page p-6 max-w-lg mx-auto bg-black text-white">
  <h2 class="text-2xl font-bold mb-6 text-center">Place Trade Order</h2>

  <div id="tradeOrderForm" class="bg-gray-900 p-5 rounded-xl border border-gray-800 space-y-4">
    <h3 class="font-semibold mb-3">Asset Selection</h3>
    <select id="tradeAssetSelect" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500">
      <option value="BINANCE:BTCUSDT">Bitcoin (BTC)</option>
      <option value="BINANCE:ETHUSDT">Ethereum (ETH)</option>
      <option value="BINANCE:BNBUSDT">BNB (BNB)</option>
    </select>

    <h3 class="font-semibold mb-3 pt-3 border-t border-gray-700">Trade Duration</h3>
    <select id="tradeDurationSelect" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500">
      <option value="30">1 Month</option>
      <option value="60">2 Months</option>
      <option value="90">3 Months</option>
      <option value="120">4 Months</option>
      <option value="150">5 Months</option>
      <option value="180">6 Months</option>
      <option value="210">7 Months</option>
      <option value="240">8 Months</option>
      <option value="270">9 Months</option>
      <option value="300">10 Months</option>
      <option value="330">11 Months</option>
      <option value="365">12 Months</option>
    </select>

    <!-- Updated Activate Trade Bot Button -->
    <button
      class="w-full mt-4 px-4 py-3 bg-green-500 text-black font-semibold rounded-md hover:bg-green-600 transition-colors"
      onclick="handlePlaceOrder()"
    >
      Activate Trade Bot
    </button>
  </div>

  <button class="mt-4 text-sm text-gray-400 hover:text-white" onclick="showPage('tradePage')">‚Üê Back to Trade</button>
</section>

    <!-- 7. WALLET DETAILS PAGE -->
    <section id="walletDetailsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Wallet Details</h2>
        <div class="space-y-4">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-400">Connected Address</div>
                <p id="walletAddressDetail" class="font-mono break-all mt-1"></p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-400">Wallet Account ID</div>
                <p id="accountIdDetail" class="font-semibold text-lg mt-1"></p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-400">Estimated Balance</div>
                <p id="walletBalanceDetail" class="font-bold text-xl mt-1 text-green-400">$0.00</p>
            </div>
        </div>
        <button class="w-full mt-6 px-4 py-3 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition-colors" onclick="handleDisconnect()">Disconnect Wallet</button>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>

    <!-- 8. SUPPORT PAGE (Gemini Chatbot) -->
    <section id="supportPage" class="page p-4 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-center">Help & Support</h2>

        <!-- FAQ Section -->
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 mb-6">
            <h3 class="font-semibold mb-3">FAQ</h3>
            <p class="text-sm text-gray-400">For immediate answers, please check our frequently asked questions.</p>
            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                <li class="text-gray-300">How do I connect my wallet?</li>
                <li class="text-gray-300">What is the daily return rate? (7.95%)</li>
                <li class="text-gray-300">How long does withdrawal processing take? (24 hours)</li>
            </ul>
        </div>

        <!-- Live Support Chat AI -->
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <h3 class="font-semibold mb-3 text-yellow-500">Live AI Support Chat</h3>
            <div id="chatWindow" class="scrollable-content h-64 bg-black p-3 rounded-lg border border-gray-700 mb-4 space-y-3">
                <div class="flex justify-start">
                    <div class="bg-gray-700 p-3 rounded-xl max-w-xs">
                        <span class="font-semibold text-yellow-500">AI Bot:</span> Welcome! I'm here to assist you with the Auto-Trading Bot. How can I help you understand trading or answer your questions?
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <input id="chatInput" type="text" placeholder="Ask a question..." class="flex-1 bg-gray-700 text-sm px-4 py-2 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" onkeydown="if(event.key === 'Enter') handleChatSend()" />
                <button class="px-3 py-2 bg-yellow-500 text-black rounded-md font-semibold hover:bg-yellow-600" onclick="handleChatSend()">Send</button>
            </div>
        </div>

        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back</button>
    </section>

    <!-- All other pages (Settings, Notifications, Transactions, etc.) are included below -->

    <!-- 9. WITHDRAWAL PAGES -->
    <!-- Withdrawal Select Popup (Hidden by default, used as a modal overlay) -->
    <div id="withdrawalSelectModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-end hidden">
        <div class="w-full bg-gray-900 rounded-t-xl p-6 border-t border-gray-700">
            <h3 class="text-xl font-bold mb-4">Select Withdrawal Method</h3>
            <div class="space-y-3">
                <button class="w-full text-left p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors" onclick="showPage('withdrawalDetailsPage'); hideWithdrawalSelect()">
                    <div class="font-semibold">On-Chain Transfer</div>
                    <div class="text-sm text-gray-400">Withdraw to an external wallet address.</div>
                </button>
                <button class="w-full text-left p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors" onclick="handleInternalWithdraw()">
                    <div class="font-semibold">User Account ID Transfer</div>
                    <div class="text-sm text-gray-400">Transfer to another Auto-Trading Bot Account ID.</div>
                </button>
            </div>
            <button class="w-full mt-4 px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600" onclick="hideWithdrawalSelect()">Cancel</button>
        </div>
    </div>

    <!-- Withdrawal Details Page -->
    <section id="withdrawalDetailsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">On-Chain Withdrawal</h2>

        <div class="space-y-4 bg-gray-900 p-5 rounded-xl border border-gray-800">
            <!-- Asset Selector (Static for USDT) -->
            <div class="p-3 bg-gray-800 rounded-lg">
                <div class="text-xs text-gray-400">Asset to Withdraw</div>
                <div class="font-semibold mt-1">USDT (Tether USD)</div>
            </div>

            <!-- Withdrawal Address -->
            <div>
                <label class="text-sm text-gray-400 block mb-1">Enter Withdrawal Address</label>
                <div class="relative">
                    <input id="withdrawalAddressInput" type="text" placeholder="Address (0x...)" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" />
                    <button class="absolute right-0 top-0 h-full px-3 text-yellow-500 text-xs font-medium" onclick="fillAddressFromConnectedWallet()">Fill from Connected Wallet</button>
                </div>
            </div>

            <!-- Select Network -->
            <div>
                <label class="text-sm text-gray-400 block mb-1">Select Network</label>
                <select id="withdrawalNetworkSelect" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" onchange="updateGasFee()">
                    <option value="bnb" selected>BNB Smart Chain (BEP20)</option>
                    <option value="eth">Ethereum (ERC-20)</option>
                    <option value="btc">Bitcoin (Native)</option>
                    <option value="tron">Tron (TRC-20)</option>
                </select>
            </div>

            <!-- Withdrawal Amount -->
            <div>
                <label class="text-sm text-gray-400 block mb-1">Enter Withdrawal Amount</label>
                <div class="relative">
                    <input id="withdrawalAmountInput" type="number" step="0.01" min="0" placeholder="0.00" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500 pr-16" />
                    <button class="absolute right-0 top-0 h-full px-3 text-yellow-500 font-bold text-sm" onclick="setMaxWithdrawal()">MAX</button>
                </div>
            </div>

            <!-- Summary -->
            <div class="border-t border-gray-700 pt-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Gas Fee:</span>
                    <span id="gasFeeLabel" class="text-white">0.034 BNB</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-gray-400">You Will Get:</span>
                    <span id="receiveAmountLabel" class="text-green-400 font-semibold">0.00 USDT</span>
                </div>
            </div>
        </div>

        <button class="w-full mt-6 px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="showWithdrawalConfirmationPage()">Withdraw</button>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>

    <!-- Withdrawal Confirmation Page -->
    <section id="withdrawalConfirmPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Confirm Withdrawal</h2>

        <div class="bg-gray-900 p-5 rounded-xl border border-gray-800 space-y-4">
            <div class="text-sm">
                <div class="text-gray-400">Address: <span id="confirmAddress" class="break-all text-white"></span></div>
                <div class="text-gray-400">Network: <span id="confirmNetwork" class="text-white"></span></div>
                <div class="text-gray-400">Amount: <span id="confirmAmount" class="text-white"></span></div>
            </div>
            <hr class="border-gray-700">
            <div>
                <label class="text-sm text-gray-400 block mb-1">Enter Verification Code</label>
                <input id="withdrawalCodeInput" type="text" placeholder="6-digit code" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" maxlength="6" />
                <p id="withdrawalAttemptsMsg" class="text-xs text-red-400 mt-2 hidden">5 attempts remaining before suspension.</p>
            </div>
            <button class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="handleWithdrawalConfirmation()">Submit</button>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('withdrawalDetailsPage')">‚Üê Back to Details</button>
    </section>

    <!-- Withdrawal Processing Page -->
    <section id="withdrawalProcessingPage" class="page p-6 max-w-lg mx-auto text-center">
        <div id="withdrawalStatus" class="p-6 rounded-xl border border-gray-800 bg-gray-900">
            <h2 class="text-2xl font-bold mb-4 text-yellow-500">Withdrawal Processing</h2>
            <p class="text-gray-300 mb-4">Your withdrawal is being processed on the blockchain. This usually takes up to 24 hours.</p>

            <div class="text-left space-y-2 text-sm bg-gray-800 p-4 rounded-lg">
                <div class="text-gray-400">Address: <span id="processAddress" class="break-all text-white"></span></div>
                <div class="text-gray-400">Network: <span id="processNetwork" class="text-white"></span></div>
                <div class="text-gray-400">Amount: <span id="processAmount" class="text-white"></span></div>
                <div class="text-gray-400 font-bold mt-3">Countdown: <span id="withdrawalCountdown" class="text-red-400">24:00:00</span></div>
            </div>

            <button class="w-full mt-6 px-4 py-3 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition-colors" onclick="showPage('transactionsPage')">View Withdrawal Details</button>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>
 
<!-- ======================================================= -->
<!-- ü™ô DEPOSIT PAGE (Select Coin) -->
<!-- ======================================================= -->
<section id="depositPage" class="page p-4 bg-black text-white min-h-screen">
  <h2 class="text-2xl font-bold mb-4">Deposit Asset</h2>

  <!-- Search Bar -->
  <input
    id="depositSearch"
    type="text"
    placeholder="Search coin to deposit..."
    class="w-full bg-gray-900 text-sm px-4 py-3 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 mb-4"
    oninput="filterDepositCoins(this.value)"
  />

  <!-- Coin List -->
  <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
    <h3 class="font-semibold mb-3">Select Coin (A‚ÄìZ)</h3>
    <div
      id="depositCoinList"
      class="space-y-2 text-sm max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900"
    >
      Loading coins...
    </div>
  </div>

  <button
    class="mt-4 text-sm text-gray-500 hover:text-white"
    onclick="showPage('home')"
  >
    ‚Üê Back to Home
  </button>
</section>

<!-- ======================================================= -->
<!-- üåê NETWORK SELECTION PAGE -->
<!-- ======================================================= -->
<section id="depositNetworkPage" class="page p-4 bg-black text-white min-h-screen hidden">
  <h2 class="text-2xl font-bold mb-6 text-center">
    Select Network for <span id="depositCoinName" class="text-yellow-400"></span>
  </h2>

  <div id="networkSelectionList" class="space-y-4">
    <!-- Networks dynamically populated -->
  </div>

  <button
    class="mt-6 text-sm text-gray-500 hover:text-white"
    onclick="showPage('depositPage')"
  >
    ‚Üê Back to Select Coin
  </button>
</section>

<!-- ======================================================= -->
<!-- üí≥ DEPOSIT ADDRESS PAGE -->
<!-- ======================================================= -->
<section id="depositAddressPage" class="page p-4 bg-black text-white min-h-screen hidden">
  <h2 class="text-2xl font-bold mb-6 text-center">
    Deposit via <span id="depositNetworkHeader" class="text-yellow-400"></span>
  </h2>

  <div class="bg-gray-900 p-5 rounded-xl border border-gray-800 space-y-4 text-center">
    <!-- QR Code -->
    <div id="qrcode" class="flex justify-center p-3"></div>

    <!-- Deposit Address -->
    <div class="text-sm font-semibold text-gray-300">Deposit Address</div>
    <div
      id="depositAddressDisplay"
      class="break-all font-mono text-sm p-3 bg-gray-800 rounded-lg border border-gray-700"
    ></div>

    <!-- Copy Address Button -->
    <button
      onclick="copyDepositAddress()"
      class="w-full px-4 py-2 bg-yellow-500 text-black rounded font-semibold text-sm hover:bg-yellow-600"
    >
      Copy Address
    </button>

    <!-- Deposit Amount -->
    <div class="pt-3">
      <label class="text-sm text-gray-400 block mb-1"
        >Enter Deposit Amount</label
      >
      <input
        id="depositAmountInput"
        type="number"
        step="0.01"
        min="0"
        placeholder="0.00"
        class="w-full bg-gray-700 text-sm px-4 py-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500"
      />
    </div>

    <!-- Proceed -->
    <button
      onclick="showDepositConfirmationPage()"
      class="w-full mt-4 px-4 py-3 bg-green-500 text-black font-semibold rounded-lg hover:bg-green-600"
    >
      Proceed to Confirmation
    </button>
  </div>

  <button
    class="mt-4 text-sm text-gray-500 hover:text-white"
    onclick="showPage('depositNetworkPage')"
  >
    ‚Üê Back to Networks
  </button>
</section>

<!-- ======================================================= -->
<!-- ‚úÖ DEPOSIT CONFIRMATION PAGE -->
<!-- ======================================================= -->
<section id="depositConfirmPage" class="page p-4 bg-black text-white min-h-screen hidden">
  <h2 class="text-2xl font-bold mb-6 text-center">Confirm Deposit</h2>

  <div class="bg-gray-900 p-5 rounded-xl border border-gray-800 space-y-4">
    <div class="text-sm">
      Deposit Amount:
      <span id="depositConfirmAmount" class="font-semibold text-green-400"></span>
    </div>

    <!-- Verification Code -->
    <label class="text-sm text-gray-400 block mb-1"
      >Enter Deposit Verification Code</label
    >
    <input
      id="depositVerificationCode"
      type="text"
      maxlength="6"
      placeholder="Enter 6-digit code"
      class="w-full bg-gray-700 text-sm px-4 py-3 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500"
    />
    <p id="depositCodeError" class="text-xs text-red-400 mt-2 hidden">
      Invalid or expired verification code.
    </p>

    <!-- Confirm -->
    <button
      onclick="handleDepositConfirmation()"
      class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-lg hover:bg-yellow-600"
    >
      Confirm Deposit
    </button>
  </div>

  <button
    class="mt-4 text-sm text-gray-500 hover:text-white"
    onclick="showPage('depositAddressPage')"
  >
    ‚Üê Back
  </button>
</section>

    <!-- 11. GOOGLE AUTH PAGE -->
    <section id="googleAuthPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Secure Account (2FA)</h2>

        <div class="bg-gray-900 p-5 rounded-xl border border-gray-800 space-y-4 text-center">
            <div class="text-sm text-gray-400">Wallet Account ID: <span id="authAccountId" class="font-semibold text-white"></span></div>

            <div class="text-left mt-4">
                <div class="text-sm font-semibold mb-2">1. Scan the QR Code:</div>
                <div id="authQRCode" class="flex justify-center p-3 bg-white rounded-lg"></div>
                <p class="mt-2 text-xs text-gray-400 break-all">Secret Key: <span id="authSecretKey" class="font-mono text-white"></span></p>
            </div>

            <div class="text-left mt-4">
                <label class="text-sm font-semibold text-gray-400 block mb-1">2. Enter 6-Digit Code</label>
                <input id="authCodeInput" type="text" placeholder="Enter 6-digit code" class="w-full bg-gray-700 text-sm px-4 py-3 rounded-md border border-gray-600 focus:outline-none focus:border-yellow-500" maxlength="6" />
            </div>

            <button class="w-full px-4 py-3 bg-yellow-500 text-black font-semibold rounded-md hover:bg-yellow-600 transition-colors" onclick="handleGoogleAuthVerification()">Verify Code & Link</button>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('accountDetailsPage')">‚Üê Back to Account</button>
    </section>

    <!-- 12. OTHER PAGES (SETTINGS, NOTIFICATIONS, TRANSACTIONS, ACCOUNT DETAILS, VIEW EARNINGS) -->

    <!-- Settings Page -->
    <section id="settingsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Settings</h2>
        <div class="space-y-4 bg-gray-900 p-5 rounded-xl border border-gray-800">
            <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                <span class="font-semibold">Daily Market Notifications</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notificationToggle" class="sr-only peer" onchange="toggleNotifications()">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                </label>
            </div>
            <button class="w-full text-left p-3 bg-gray-800 rounded-lg hover:bg-gray-700" onclick="showPage('accountDetailsPage')">
                <div class="font-semibold">Account Details</div>
                <div class="text-sm text-gray-400">View wallet ID, security, and connected address.</div>
            </button>
            <button class="w-full text-left p-3 bg-gray-800 rounded-lg hover:bg-gray-700" onclick="handleCloseAccount()">
                <div class="font-semibold text-red-400">Close Account</div>
                <div class="text-sm text-gray-400">Deactivate this Wallet Account ID permanently.</div>
            </button>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>

    <!-- Notifications Page -->
    <section id="notificationsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Notifications</h2>
        <div id="notificationList" class="space-y-3 bg-gray-900 p-4 rounded-xl border border-gray-800 scrollable-content h-96">
            <div class="text-gray-500">No new notifications.</div>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>

    <!-- Transactions/Activity Page -->
    <section id="transactionsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Transactions & Activities</h2>
        <div id="fullActivityList" class="space-y-3 bg-gray-900 p-4 rounded-xl border border-gray-800 scrollable-content h-96">
            <div class="text-gray-500">All confirmed transactions and ongoing activities will appear here.</div>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('home')">‚Üê Back to Home</button>
    </section>

    <!-- Account Details Page -->
    <section id="accountDetailsPage" class="page p-6 max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">Account Details</h2>
        <div class="space-y-4 bg-gray-900 p-5 rounded-xl border border-gray-800">
            <div class="p-3 bg-gray-800 rounded-lg">
                <div class="text-xs text-gray-400">Wallet Account ID</div>
                <p id="detailAccountId" class="font-semibold text-lg mt-1"></p>
            </div>
            <div class="p-3 bg-gray-800 rounded-lg">
                <div class="text-xs text-gray-400">Connected Wallet Address</div>
                <p id="detailWalletAddress" class="font-mono break-all mt-1"></p>
            </div>
            <div class="p-3 bg-gray-800 rounded-lg">
                <div class="text-xs text-gray-400">Current Balance (Simulated)</div>
                <p id="detailWalletBalance" class="font-bold text-xl mt-1 text-green-400">$0.00</p>
            </div>
            <button class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors" onclick="showPage('googleAuthPage')">Secure Account (Google Auth)</button>
            <button class="w-full px-4 py-3 bg-gray-700 text-white font-semibold rounded-md hover:bg-gray-600" onclick="handleSaveAccountDetails()">Save Account Details</button>
        </div>
        <button class="mt-4 text-sm text-gray-500 hover:text-white" onclick="showPage('settingsPage')">‚Üê Back to Settings</button>
    </section>

    </main>

    <!-- ===== FOOTER (Post-Login Navigation) ===== -->
    <footer id="appFooter" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 z-20 hidden">
        <div class="flex justify-around items-center h-16 text-xs font-medium">
            <button class="flex flex-col items-center p-2 nav-tab" data-page="home">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="mt-1">Home</span>
            </button>
            <button class="flex flex-col items-center p-2 nav-tab" data-page="marketPage">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18l5-5 4 4 4-4 5 5"/><path d="M18 13h4v4"/><path d="M21 3h-4l-4 4-4-4-5 5v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"/></svg>
                <span class="mt-1">Markets</span>
            </button>
            <button class="flex flex-col items-center p-2 nav-tab" data-page="tradePage">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M18 10h-6"/><path d="M6 14h6"/><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg>
                <span class="mt-1">Trade</span>
            </button>
            <button class="flex flex-col items-center p-2 nav-tab" data-page="walletDetailsPage">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6"/><path d="M16 8h2v2h-2z"/><path d="M17 17h2v2h-2z"/><path d="M22 13v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v6"/><path d="M12 17h2v2h-2z"/></svg>
                <span class="mt-1">Wallet</span>
            </button>
        </div>
    </footer>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
 <script>
        // =======================================================
        // 1. CONFIGURATION & STATE
        // =======================================================

        const STATE_KEY = 'aiTradingBotState';
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key='; // Key added at runtime
        const IMAGEN_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key='; // Key added at runtime
        
        // Provided IDs/Keys (WalletConnect/Infura are for flow simulation only)
        const PROVIDED_IDS = {
            walletConnectProjectId: 'cedd3cec8430b2990ce3fe466ecb1a29',
            infuraId: 'c35d1ef971da479b918c9900134867d4',
            web3Api: '0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204'
        };

        const WITHDRAWAL_CODES = [
            "483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", "356701", "740528",
        ];
        let appState = {
            isLoggedIn: false,
            userId: null, // 10-digit account ID
            walletAddress: null, // Shortened or full address
            currentPage: 'landingPage',
            balances: {
                totalUSD: 0.00,
                tradeUSD: 0.00,
                usdtBalance: 0.00, // Core asset holding
            },
            trade: {
                active: false,
                asset: null, // e.g., 'BINANCE:BTCUSDT'
                durationDays: 0,
                startTime: null,
                tradeBalance: 0.00,
                returnsUSD: 0.00,
            },
            withdrawal: {
                active: false,
                targetTime: null, // Timestamp for 24hr completion
                amount: 0.00,
                address: null,
                network: null,
                attempts: 0,
                suspensionEndTime: null, // Timestamp for 48hr suspension
            },
            notifications: [],
            settings: {
                notificationsOn: true,
                usedDepositCodes: [],
                googleAuthSecret: null,
                isAuthVerified: false,
                lastNotificationTime: null, // For daily market updates
            },
            activities: [],
            marketData: [],
            chatHistory: [],
        };
        let promptDeferred; // For PWA install prompt
        let countdownInterval; // For withdrawal/trade countdown

        // =======================================================
        // 2. UTILITY FUNCTIONS
        // =======================================================

        function generateWalletId() {
            return Math.floor(1000000000 + Math.random() * 9000000000).toString();
        }

        function shortenAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function saveState() {
            try {
                localStorage.setItem(STATE_KEY, JSON.stringify(appState));
            } catch (error) {
                console.error("Could not save state:", error);
            }
        }

        function loadState() {
            try {
                const storedState = localStorage.getItem(STATE_KEY);
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    // Merge with default state to handle new properties
                    appState = { ...appState, ...loadedState };
                }
            } catch (error) {
                console.error("Could not load state:", error);
            }
        }

        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('globalModal').classList.remove('hidden');
            return new Promise(resolve => {
                document.getElementById('modalConfirm').onclick = () => {
                    document.getElementById('globalModal').classList.add('hidden');
                    resolve();
                };
            });
        }

        async function waitFor(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showPage(pageId, isBack = false) {
            // Only hide/show if not already on the page
            if (appState.currentPage === pageId && !isBack) return;

            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');

            // Show the selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                appState.currentPage = pageId;
                saveState();
                
                // Update UI for the new page
                updateAppUI(pageId);

                // Update tab highlighting
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('tab-active');
                    if (tab.dataset.page === pageId) {
                        tab.classList.add('tab-active');
                    }
                });
            }

            // Always ensure header/footer visibility based on login state
            const header = document.getElementById('appHeader');
            const footer = document.getElementById('appFooter');
            
            if (pageId === 'landingPage') {
                header.classList.add('hidden');
                footer.classList.add('hidden');
            } else if (appState.isLoggedIn) {
                header.classList.remove('hidden');
                // Only show footer on main navigation pages
                if (['home', 'marketPage', 'tradePage', 'walletDetailsPage'].includes(pageId)) {
                    footer.classList.remove('hidden');
                } else {
                    footer.classList.add('hidden');
                }
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        // =======================================================
        // 3. PWA INSTALLATION LOGIC
        // =======================================================

        function registerPWA() {
            // 1. Create and Register manifest.json blob
            const manifestContent = {
                name: "AI Trading Bot",
                short_name: "AI Bot",
                start_url: "./index.html",
                display: "standalone",
                background_color: "#000000",
                theme_color: "#f0b90b",
                icons: [
                    { src: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí±</text></svg>', sizes: '192x192', type: 'image/svg+xml' },
                    { src: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí±</text></svg>', sizes: '512x512', type: 'image/svg+xml' }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('pwa-manifest-link').setAttribute('href', manifestURL);

            // 2. Create and Register service-worker.js blob
            const serviceWorkerCode = `
                const CACHE_NAME = 'ai-trading-bot-v1';
                const urlsToCache = ['./index.html', './', 'https://cdn.tailwindcss.com', 'https://s3.tradingview.com/tv.js'];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            if (response) { return response; }
                            return fetch(event.request);
                        })
                    );
                });
            `;
            const swBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(swBlob);

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swURL).then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, error => {
                        console.error('ServiceWorker registration failed: ', error);
                    });
                });
            }
        }

        function setupInstallPrompt() {
            const installPromptContainer = document.getElementById('installPromptContainer');
            const installNowBtn = document.getElementById('pwaInstallNow');
            const installLaterBtn = document.getElementById('pwaInstallLater');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                promptDeferred = e; // Store the event for later use
                // Only show the custom prompt if we are on the landing page
                if (appState.currentPage === 'landingPage') {
                    installPromptContainer.classList.remove('hidden');
                }
            });

            document.getElementById('installAppBtn').addEventListener('click', () => {
                if (promptDeferred) {
                    installPromptContainer.classList.remove('hidden');
                } else {
                    showModal('App Install', 'The app is not eligible for installation yet, or is already installed. Try using the browser menu to install.');
                }
            });

            installNowBtn.addEventListener('click', () => {
                installPromptContainer.classList.add('hidden');
                if (promptDeferred) {
                    promptDeferred.prompt();
                    promptDeferred.userChoice.then((choiceResult) => {
                        console.log('User choice:', choiceResult.outcome);
                        promptDeferred = null;
                        if (choiceResult.outcome === 'accepted') {
                            showModal('Success', 'App installation started!');
                        }
                    });
                }
            });

            installLaterBtn.addEventListener('click', () => {
                installPromptContainer.classList.add('hidden');
            });
        }

        function hideNotification() {
            document.getElementById('dailyNotification').classList.add('hidden');
        }

        // =======================================================
        // 4. AUTHENTICATION & NAVIGATION
        // =======================================================

        function handleAuth(walletAddress) {
            showLoading('Connecting wallet...');
            appState.walletAddress = walletAddress;
            appState.userId = generateWalletId(); // Generate new ID
            appState.isLoggedIn = true;
            appState.balances.totalUSD = 8250.78;
            appState.balances.usdtBalance = 8250.78;
            appState.activities.push({
                type: 'Connect',
                message: `Wallet ${shortenAddress(walletAddress)} connected. Account ID: ${appState.userId} generated.`,
                timestamp: Date.now(),
            });
            saveState();

            // Auto-redirect and hide loading after 1.5s
            setTimeout(() => {
                hideLoading();
                showPage('home');
                showNotificationPopup(`Account ID ${appState.userId} created. Tap 'Save Account' in Settings ‚Üí Account Details.`);
            }, 1500);
        }

        async function handleWeb3Connect() {
            showLoading('Initiating WalletConnect...');
            await waitFor(5000); // Simulate connection loading and mobile redirect
            
            // Simulating successful connection to a wallet address
            const mockAddress = `0x${Math.random().toString(16).substring(2, 42)}`;
            
            // Simulating a 'Confirm' button redirect back from mobile wallet
            // In a real app, this would redirect with a payload
            await showModal('Connection Confirmed', `Successfully connected to wallet: ${shortenAddress(mockAddress)}. Final confirmation loading...`);
            
            showLoading('Confirming connection...');
            await waitFor(15000); // Final 15-second loading
            
            handleAuth(mockAddress);
        }

        async function handleManualConnect() {
            const address = document.getElementById('manualWalletAddress').value.trim();
            if (!address || address.length < 10) {
                return showModal('Error', 'Please enter a valid-looking wallet address.');
            }
            
            showLoading('Connecting address and fetching balances...');
            await waitFor(15000); // 15-second loading

            handleAuth(address);
        }

        async function handleLoginId() {
            const id = document.getElementById('loginAccountId').value.trim();
            if (!id || id.length !== 10) {
                return showModal('Error', 'Please enter a valid 10-digit Account ID.');
            }

            showLoading('Logging in...');
            await waitFor(15000); // 15-second loading

            // Check if the entered ID is a previously generated, non-deactivated ID
            if (id === appState.userId && !appState.isDeactivated) {
                appState.isLoggedIn = true;
                saveState();
                hideLoading();
                showPage('home');
            } else {
                hideLoading();
                showModal('Login Failed', 'Account ID not found or deactivated. Please connect your wallet to get a wallet ID.');
            }
        }

        async function handleDisconnect() {
            showLoading('Disconnecting wallet...');
            await waitFor(15000);

            // Reset only user-specific persistent state but keep general settings
            appState.isLoggedIn = false;
            appState.userId = null;
            appState.walletAddress = null;
            appState.balances = { totalUSD: 0.00, tradeUSD: 0.00, usdtBalance: 0.00 };
            appState.trade = { active: false, asset: null, durationDays: 0, startTime: null, tradeBalance: 0.00, returnsUSD: 0.00 };
            appState.withdrawal.active = false;
            clearInterval(countdownInterval);
            
            saveState();
            hideLoading();
            showPage('landingPage');
        }

        async function handleCloseAccount() {
            const confirm = await showModal('Confirm Deactivation', 'Are you sure you want to close this account? This will permanently disable login functions for this ID.');
            
            showLoading('Deactivating account...');
            await waitFor(15000);

            // Deactivate logic
            appState.isDeactivated = true;
            await handleDisconnect(); // Disconnect and clear session
            
            saveState();
            hideLoading();
            showModal('Account Closed', 'Your account has been successfully deactivated.');
        }

        // =======================================================
        // 5. DATA FETCHING & UI UPDATES
        // =======================================================

        function updateAppUI(pageId = appState.currentPage) {
            if (!appState.isLoggedIn) {
                // If not logged in, ensure we are on the landing page
                if (pageId !== 'landingPage' && pageId !== 'walletConnectorPage' && pageId !== 'loginIdPage') {
                    showPage('landingPage');
                }
                return;
            }

            // Global UI Updates
            document.getElementById('homeWalletId').textContent = appState.userId || 'N/A';
            document.getElementById('totalBalance').textContent = formatCurrency(appState.balances.totalUSD);
            document.getElementById('tokenHoldingsValue').textContent = formatCurrency(appState.balances.usdtBalance);
            document.getElementById('usdtBalance').textContent = `${appState.balances.usdtBalance.toFixed(4)} USDT`;
            document.getElementById('walletAddressDetail').textContent = appState.walletAddress || 'N/A';
            document.getElementById('accountIdDetail').textContent = appState.userId || 'N/A';
            document.getElementById('walletBalanceDetail').textContent = formatCurrency(appState.balances.totalUSD);
            
            // Specific Page Updates
            if (pageId === 'tradePage') {
                updateTradeUI();
            } else if (pageId === 'viewEarningsPage') {
                updateViewEarningsUI();
            }
            // Update activities list on home and transactions page
            renderActivities();
            
            // Check for ongoing withdrawal suspension
            checkWithdrawalSuspension();
        }

        async function fetchMarketData() {
            showLoading('Fetching live market data...');
            try {
                // Fetch top 10 coins by market cap
                const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false`);
                if (!response.ok) throw new Error('Failed to fetch market data');
                appState.marketData = await response.json();
                saveState();
                
                renderMarketData(appState.marketData);

                // Simulate USDT price update (CoinGecko only provides general data, we assume 1.00 for USDT)
                document.getElementById('usdtPrice').textContent = '$1.00'; 
                
            } catch (error) {
                console.error("Error fetching market data:", error);
                await showModal('API Error', 'Could not load live market data from CoinGecko.');
            } finally {
                hideLoading();
            }
        }

        function renderMarketData(coins) {
            // Landing Page Overview (Top 5)
            const landingOverviewEl = document.getElementById('landingMarketOverview');
            landingOverviewEl.innerHTML = `<div class="flex space-x-6 text-sm whitespace-nowrap">${coins.slice(0, 5).map(coin => `
                <div class="flex flex-col p-2 rounded-lg ${coin.price_change_percentage_24h > 0 ? 'text-green-400' : 'text-red-400'}">
                    <div class="font-semibold">${coin.symbol.toUpperCase()}/USD</div>
                    <div class="text-white font-bold">${formatCurrency(coin.current_price)}</div>
                    <div class="text-xs">${coin.price_change_percentage_24h.toFixed(2)}%</div>
                </div>
            `).join('')}</div>`;

            // Home Page Top Coins List
            const homeListEl = document.getElementById('topCoinsList');
            homeListEl.innerHTML = coins.map(coin => `
                <div class="flex items-center justify-between coin-row p-2 rounded-lg">
                    <div class="flex items-center gap-3">
                        <img src="${coin.image}" class="w-6 h-6 rounded-full" alt="${coin.symbol.toUpperCase()} logo" onerror="this.src='https://placehold.co/24x24/9ca3af/ffffff?text=${coin.symbol.toUpperCase().charAt(0)}'" />
                        <div>
                            <div class="font-semibold">${coin.symbol.toUpperCase()}</div>
                            <div class="text-xs text-gray-400">${coin.name}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${formatCurrency(coin.current_price)}</div>
                        <div class="text-xs ${coin.price_change_percentage_24h > 0 ? 'text-green-400' : 'text-red-400'}">${coin.price_change_percentage_24h.toFixed(2)}%</div>
                    </div>
                </div>
            `).join('');

            // Market Page lists
            const allCoins = coins.slice(0, 50); // Use a reasonable subset for A-Z
            allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol));
            
            document.getElementById('marketCoinList').innerHTML = allCoins.map(coin => `
                <div class="flex items-center justify-between coin-row p-2 rounded-lg cursor-pointer" onclick="showMarketCoinChart('${coin.symbol.toUpperCase()}USDT')">
                    <div class="flex items-center gap-3">
                        <img src="${coin.image}" class="w-6 h-6 rounded-full" alt="${coin.symbol.toUpperCase()} logo" onerror="this.src='https://placehold.co/24x24/9ca3af/ffffff?text=${coin.symbol.toUpperCase().charAt(0)}'" />
                        <div class="font-semibold">${coin.symbol.toUpperCase()}/USDT</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${formatCurrency(coin.current_price)}</div>
                        <div class="text-xs ${coin.price_change_percentage_24h > 0 ? 'text-green-400' : 'text-red-400'}">${coin.price_change_percentage_24h.toFixed(2)}%</div>
                    </div>
                </div>
            `).join('');

            // Gainers/Losers
            const gainers = coins.sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h).slice(0, 5);
            const losers = coins.sort((a, b) => a.price_change_percentage_24h - b.price_change_percentage_24h).slice(0, 5);

            document.getElementById('gainersList').innerHTML = gainers.map(coin => `<div class="flex justify-between"><span class="font-semibold">${coin.symbol.toUpperCase()}</span><span class="text-green-400">${coin.price_change_percentage_24h.toFixed(2)}%</span></div>`).join('');
            document.getElementById('losersList').innerHTML = losers.map(coin => `<div class="flex justify-between"><span class="font-semibold">${coin.symbol.toUpperCase()}</span><span class="text-red-400">${coin.price_change_percentage_24h.toFixed(2)}%</span></div>`).join('');
        }
        
        // TradingView Initialization
        function initializeTradingViewChart(containerId, symbol = 'BINANCE:BTCUSDT') {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear previous content
            container.innerHTML = ''; 

            new TradingView.widget({
                "width": container.clientWidth || 320, // Responsive width
                "height": container.clientHeight || 300,
                "symbol": symbol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "save_image": false,
                "container_id": containerId,
                "autosize": true
            });
        }

        function showMarketCoinChart(symbol) {
            document.getElementById('marketCoinChartContainer').classList.remove('hidden');
            initializeTradingViewChart('marketCoinChart', `BINANCE:${symbol}`);
        }

        // =======================================================
        // 6. WITHDRAWAL LOGIC
        // =======================================================

        function checkWithdrawalSuspension() {
            const now = Date.now();
            if (appState.withdrawal.suspensionEndTime && now < appState.withdrawal.suspensionEndTime) {
                // User is suspended
                const remainingMs = appState.withdrawal.suspensionEndTime - now;
                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

                const msg = `Withdrawal Suspended: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} remaining.`;
                
                // Add to activities list if not already there
                if (!appState.activities.some(a => a.type === 'Suspension' && a.message.includes('remaining'))) {
                    appState.activities.push({ type: 'Suspension', message: msg, timestamp: Date.now() });
                    saveState();
                }
                
                // Update home activity list
                renderActivities();
                
                // Re-run check every second
                setTimeout(checkWithdrawalSuspension, 1000);
            } else if (appState.withdrawal.suspensionEndTime && now >= appState.withdrawal.suspensionEndTime) {
                // Suspension lifted
                appState.withdrawal.suspensionEndTime = null;
                appState.withdrawal.attempts = 0;
                appState.activities.push({ type: 'Info', message: 'Withdrawal suspension lifted.', timestamp: Date.now() });
                saveState();
                renderActivities();
            }
        }

        function showWithdrawalSelect() {
            if (appState.withdrawal.suspensionEndTime && Date.now() < appState.withdrawal.suspensionEndTime) {
                return showModal('Withdrawal Blocked', 'Your withdrawal functions are suspended due to 5 failed verification attempts. Please wait for the suspension period to end.');
            }
            document.getElementById('withdrawalSelectModal').classList.remove('hidden');
        }

        function hideWithdrawalSelect() {
            document.getElementById('withdrawalSelectModal').classList.add('hidden');
        }

        function updateGasFee() {
            // Placeholder logic: different networks have different simulated fees
            const network = document.getElementById('withdrawalNetworkSelect').value;
            let fee = 0.034;
            if (network === 'eth') fee = 0.005;
            if (network === 'btc') fee = 0.0001;
            
            document.getElementById('gasFeeLabel').textContent = `${fee} ${network.toUpperCase()}`;
            calculateReceiveAmount();
        }

        function calculateReceiveAmount() {
            const amount = parseFloat(document.getElementById('withdrawalAmountInput').value) || 0;
            // Simplified: fee deducted in the logic, here we show the amount
            document.getElementById('receiveAmountLabel').textContent = `${amount.toFixed(2)} USDT`;
        }
        
        function setMaxWithdrawal() {
            const maxAmount = appState.balances.usdtBalance;
            document.getElementById('withdrawalAmountInput').value = maxAmount.toFixed(2);
            calculateReceiveAmount();
        }

        function fillAddressFromConnectedWallet() {
            document.getElementById('withdrawalAddressInput').value = appState.walletAddress;
        }

        function showWithdrawalConfirmationPage() {
            const address = document.getElementById('withdrawalAddressInput').value.trim();
            const network = document.getElementById('withdrawalNetworkSelect').options[document.getElementById('withdrawalNetworkSelect').selectedIndex].text;
            const amount = parseFloat(document.getElementById('withdrawalAmountInput').value);

            if (!address || address.length < 10) return showModal('Error', 'Please enter a valid withdrawal address.');
            if (isNaN(amount) || amount <= 0 || amount > appState.balances.usdtBalance) return showModal('Error', 'Invalid amount. Must be greater than 0 and less than your USDT balance.');

            // Store details for confirmation/processing
            appState.withdrawal.amount = amount;
            appState.withdrawal.address = address;
            appState.withdrawal.network = network;
            appState.withdrawal.targetTime = null; // Clear any previous state

            // Update confirmation page details
            document.getElementById('confirmAddress').textContent = shortenAddress(address);
            document.getElementById('confirmNetwork').textContent = network;
            document.getElementById('confirmAmount').textContent = `${amount.toFixed(2)} USDT`;
            document.getElementById('withdrawalCodeInput').value = '';
            document.getElementById('withdrawalAttemptsMsg').classList.add('hidden');

            showPage('withdrawalConfirmPage');
        }

        async function handleWithdrawalConfirmation() {
            const code = document.getElementById('withdrawalCodeInput').value.trim();
            
            if (!code || code.length !== 6) {
                return showModal('Error', 'Please enter the 6-digit validation code.');
            }
            
            showLoading('Validating code...');
            await waitFor(15000);

            if (WITHDRAWAL_CODES.includes(code)) {
                // Success
                appState.withdrawal.attempts = 0;
                appState.withdrawal.active = true;
                appState.withdrawal.targetTime = Date.now() + 24 * 60 * 60 * 1000; // 24 hours from now
                
                appState.activities.push({
                    type: 'Withdrawal',
                    message: `Withdrawal of ${appState.withdrawal.amount.toFixed(2)} USDT to ${shortenAddress(appState.withdrawal.address)} processing.`,
                    timestamp: Date.now(),
                    countdownTarget: appState.withdrawal.targetTime,
                });
                
                saveState();
                hideLoading();
                startWithdrawalCountdown();
                showWithdrawalProcessingPage();
            } else {
                // Failure
                appState.withdrawal.attempts++;
                const attemptsLeft = 5 - appState.withdrawal.attempts;
                
                if (appState.withdrawal.attempts >= 5) {
                    // Suspension
                    appState.withdrawal.suspensionEndTime = Date.now() + 48 * 60 * 60 * 1000; // 48 hours
                    appState.activities.push({ type: 'Suspension', message: `5 failed withdrawal attempts. Withdrawal functions suspended for 48 hours.`, timestamp: Date.now() });
                    saveState();
                    hideLoading();
                    showModal('Suspension', 'Validation failed 5 times. Withdrawal functions are now suspended for 48 hours.');
                    showPage('home');
                    checkWithdrawalSuspension(); // Start the suspension countdown
                } else {
                    // Alert and display attempts remaining
                    document.getElementById('withdrawalAttemptsMsg').textContent = `${attemptsLeft} attempts remaining before suspension.`;
                    document.getElementById('withdrawalAttemptsMsg').classList.remove('hidden');
                    hideLoading();
                    showModal('Validation Failed', 'Incorrect code. Please enter the correct code.');
                    saveState();
                }
            }
        }

        function showWithdrawalProcessingPage() {
            document.getElementById('processAddress').textContent = shortenAddress(appState.withdrawal.address);
            document.getElementById('processNetwork').textContent = appState.withdrawal.network;
            document.getElementById('processAmount').textContent = `${appState.withdrawal.amount.toFixed(2)} USDT`;
            showPage('withdrawalProcessingPage');
        }

// =======================================================
// 7. DEPOSIT LOGIC (Fully Updated & Working)
// =======================================================

// Selected coin data
let selectedDepositCoin = null;

// Current deposit state
let currentDeposit = {};

// Cached coin list
let allCoins = [];

// Deposit verification codes (simulated for validation)
const DEPOSIT_CODES = [
  482915, 930472, 158203, 764981, 502319, 847261, 319586, 672450, 248391, 905836,
  731258, 629047, 580124, 417902, 896351, 264098, 152983, 309472, 741826, 589320,
  620583, 958210, 203874, 742985, 894621, 510293, 673420, 248765, 901632, 437892
];

// Supported networks per coin
const DEPOSIT_NETWORKS = {
  USDT: ['Ethereum', 'Tron', 'BSC'],
  BTC: ['Bitcoin'],
  ETH: ['Ethereum'],
  BNB: ['BNB Smart Chain'],
  TRX: ['Tron']
};

// Deposit wallet addresses
const DEPOSIT_ADDRESSES = {
  'ETHEREUM': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
  'TRON': 'TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco',
  'BSC': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
  'BITCOIN': 'bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu'
};

// =======================================================
// Load deposit coins from CoinGecko Public API (A‚ÄìZ)
// =======================================================
async function loadDepositCoins() {
  const depositCoinList = document.getElementById('depositCoinList');
  if (!depositCoinList) return;

  depositCoinList.innerHTML = `<p class="text-center text-gray-400 py-4">Loading coins...</p>`;

  try {
    if (allCoins.length === 0) {
      const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false`);
      if (!response.ok) throw new Error('Failed to fetch deposit coins');
      allCoins = await response.json();
    }

    allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort A‚ÄìZ
    renderDepositCoinList(allCoins);
  } catch (error) {
    console.error("Error loading deposit coins:", error);
    depositCoinList.innerHTML = `<p class="text-center text-red-500 py-4">Failed to load coins. Please try again later.</p>`;
  }

  // Attach live search
  const searchInput = document.getElementById('depositSearch');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.trim().toLowerCase();
      if (!searchTerm) {
        renderDepositCoinList(allCoins);
        return;
      }
      const filtered = allCoins.filter(
        c =>
          c.name.toLowerCase().includes(searchTerm) ||
          c.symbol.toLowerCase().includes(searchTerm)
      );
      renderDepositCoinList(filtered);
    });
  }
}

// =======================================================
// Render Deposit Coin List
// =======================================================
function renderDepositCoinList(coins) {
  const container = document.getElementById('depositCoinList');
  if (!container) return;

  if (!coins || coins.length === 0) {
    container.innerHTML = `<p class="text-center text-gray-400 py-4">No matching coins found.</p>`;
    return;
  }

  let html = '';
  coins.forEach(coin => {
    html += `
      <div class="deposit-coin-item flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-800 hover:bg-gray-800 cursor-pointer"
           data-symbol="${coin.symbol.toUpperCase()}" 
           data-name="${coin.name}" 
           data-id="${coin.id}" 
           data-image="${coin.image}">
        <div class="flex items-center gap-3">
          <img src="${coin.image}" class="w-8 h-8 rounded-full"
            onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" />
          <div>
            <p class="font-semibold">${coin.symbol.toUpperCase()}</p>
            <p class="text-xs text-gray-400">${coin.name}</p>
          </div>
        </div>
        <svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    `;
  });

  container.innerHTML = html;

  // Add click handlers for each coin
  document.querySelectorAll('.deposit-coin-item').forEach(item => {
    item.addEventListener('click', () => {
      const symbol = item.dataset.symbol;
      const image = item.dataset.image;
      selectDepositCoin(symbol, image);
    });
  });
}

// =======================================================
// Select a Deposit Coin
// =======================================================
function selectDepositCoin(symbol, image) {
  selectedDepositCoin = { symbol, image };
  document.getElementById('depositCoinName').textContent = symbol;
  renderNetworkSelection(symbol);
  showPage('depositNetworkPage');
}

// =======================================================
// Render Network Selection Page
// =======================================================
function renderNetworkSelection(coinSymbol) {
  const container = document.getElementById('networkSelectionList');
  if (!container) return;

  const networks = DEPOSIT_NETWORKS[coinSymbol] || ['Ethereum'];
  container.innerHTML = networks.map(network => `
    <button class="network-select-btn w-full flex items-center py-4 px-5 bg-gray-900 border border-gray-700 rounded-xl hover:bg-gray-800 transition"
            data-network="${network}">
      <span class="text-md font-semibold">${network}</span>
      <svg class="w-5 h-5 ml-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
      </svg>
    </button>
  `).join('');

  // Add click handler for each network
  document.querySelectorAll('.network-select-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const network = btn.dataset.network;
      openDepositAddressPage(selectedDepositCoin.symbol, network);
    });
  });
}

// =======================================================
// Open Deposit Address Page (with QR code)
// =======================================================
function openDepositAddressPage(symbol, network) {
  const address = DEPOSIT_ADDRESSES[network.toUpperCase()];
  if (!address) {
    showMessage(`No deposit address found for ${symbol} on ${network}.`, 'error');
    return;
  }

  currentDeposit = { coin: symbol, network, address };
  showPage('depositAddressPage');

  document.getElementById('depositNetworkHeader').textContent = network;
  document.getElementById('depositAddressDisplay').textContent = address;

  // Generate QR code
  const qrContainer = document.getElementById('qrcode');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: address,
    width: 160,
    height: 160,
    colorDark: "#ffffff",
    colorLight: "#000000",
    correctLevel: QRCode.CorrectLevel.H
  });
}

// =======================================================
// Copy Deposit Address
// =======================================================
function copyDepositAddress() {
  const address = document.getElementById('depositAddressDisplay').textContent;
  if (!address) return;

  navigator.clipboard.writeText(address)
    .then(() => showMessage('Address copied to clipboard!', 'success'))
    .catch(() => showMessage('Failed to copy address.', 'error'));
}

// =======================================================
// Deposit Confirmation Flow
// =======================================================
function showDepositConfirmationPage() {
  const amount = parseFloat(document.getElementById('depositAmountInput').value);
  if (isNaN(amount) || amount <= 0) {
    showMessage('Please enter a valid deposit amount.', 'error');
    return;
  }

  currentDeposit.amount = amount;
  document.getElementById('depositConfirmAmount').textContent = amount.toFixed(2);
  showPage('depositConfirmPage');
}

// =======================================================
// Handle Deposit Confirmation
// =======================================================
async function handleDepositConfirmation() {
  const code = parseInt(document.getElementById('depositVerificationCode').value);
  const errorMsg = document.getElementById('depositCodeError');
  if (!code) {
    errorMsg.textContent = 'Enter your 6-digit verification code.';
    errorMsg.classList.remove('hidden');
    return;
  }

  errorMsg.classList.add('hidden');
  showLoading('Processing deposit...');
  await waitFor(15000);

  if (!DEPOSIT_CODES.includes(code)) {
    hideLoading();
    errorMsg.textContent = 'Invalid or used verification code.';
    errorMsg.classList.remove('hidden');
    return;
  }

  appState.balances.totalUSD += currentDeposit.amount;
  appState.balances.tradeUSD += currentDeposit.amount;

  appState.activities.unshift({
    type: 'Deposit',
    desc: `Deposited ${currentDeposit.amount.toFixed(2)} ${currentDeposit.coin} via ${currentDeposit.network}.`,
    date: new Date().toISOString(),
    status: 'Success'
  });

  saveState();
  hideLoading();
  showModal('Deposit Successful', `Successfully deposited ${currentDeposit.amount.toFixed(2)} ${currentDeposit.coin}.`);
  showPage('home');
}
// =======================================================
// 8. TRADE LOGIC (Live Returns + TradingView Live Price Charts + Cumulative Earnings)
// =======================================================
let tradeProjectionChartInstance = null;
let earningsProjectionChartInstance = null;
let tradeInterval = null;

// --- Initialize Trade on Page Load ---
function initTradePage() {
  loadState();

  if (appState.trade.active) {
    startTradeReturnsLoop();
    updateTradeUI();
    updateViewEarningsUI();
    initializeTradingViewChartOnce('tradeLiveChart', appState.trade.asset);
    initializeTradingViewChartOnce('earningsLiveChart', appState.trade.asset);
    renderGrowthProjectionChart("tradeProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "trade");
    renderGrowthProjectionChart("earningsProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "earnings");
  } else {
    updateTradeUI();
    updateViewEarningsUI();
  }
}

// --- Show Trade Order Page ---
function showTradeOrderPage() {
  if (appState.balances.tradeUSD <= 0)
    return showModal(
      'Trade Balance Required',
      'Your Trade Balance is $0.00. Please deposit or transfer funds to the Trade Account first.'
    );

  if (appState.trade.active)
    return showModal(
      'Trade Active',
      `You already have an active trade for ${appState.trade.asset.split(':')[1]} running until ${new Date(
        appState.trade.startTime + appState.trade.durationDays * 24 * 60 * 60 * 1000
      ).toLocaleDateString()}.`
    );

  showPage('tradeOrderPage');
}

// --- Place Trade Order ---
async function handlePlaceOrder() {
  const assetSymbol = document.getElementById('tradeAssetSelect').value;
  const durationDays = parseInt(document.getElementById('tradeDurationSelect').value, 10);

  showLoading('Validating and activating trade...');
  await waitFor(15000);

  appState.trade = {
    active: true,
    asset: assetSymbol,
    durationDays,
    startTime: Date.now(),
    tradeBalance: appState.balances.tradeUSD,
    returnsUSD: 0,
    percentageReturns: 0
  };

  saveState();
  hideLoading();

  showModal('Trade Activation Successful', 'Your trade bot has been successfully activated and is now running.');
  setTimeout(() => {
    showPage('tradePage');
    updateTradeUI();
  }, 2000);

  startTradeReturnsLoop();
  initializeTradingViewChartOnce('tradeLiveChart', assetSymbol);
  initializeTradingViewChartOnce('earningsLiveChart', assetSymbol);
  renderGrowthProjectionChart("tradeProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "trade");
  renderGrowthProjectionChart("earningsProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "earnings");
}

// --- Trade Returns Loop (Persistent Calculation) ---
function startTradeReturnsLoop() {
  if (tradeInterval) clearInterval(tradeInterval);
  const dailyRate = 0.0795; // 7.95% daily rate

  const updateReturns = () => {
    if (!appState.trade.active) return;

    const elapsedSeconds = (Date.now() - appState.trade.startTime) / 1000;
    const totalReturn = appState.trade.tradeBalance * (Math.pow(1 + dailyRate, elapsedSeconds / (24 * 60 * 60)) - 1);

    appState.trade.returnsUSD = totalReturn;
    appState.trade.percentageReturns = (appState.trade.returnsUSD / appState.trade.tradeBalance) * 100;

    const totalDurationMs = appState.trade.durationDays * 24 * 60 * 60 * 1000;
    if (Date.now() - appState.trade.startTime >= totalDurationMs) {
      handleTradeEnd();
      return;
    }

    saveState();
    updateTradeUI();
    updateViewEarningsUI();
  };

  updateReturns(); // Run immediately
  tradeInterval = setInterval(updateReturns, 1000); // Keep running every second
}

// --- Trade Completion ---
function handleTradeEnd() {
  if (!appState.trade.active) return;
  clearInterval(tradeInterval);

  const finalEarning = appState.trade.returnsUSD;
  appState.cumulativeEarnings = (appState.cumulativeEarnings || 0) + finalEarning;

  appState.activities.push({
    type: 'Trade End',
    message: `Trade for ${appState.trade.asset.split(':')[1]} completed! Total earning: ${formatCurrency(finalEarning)}.`,
    timestamp: Date.now(),
  });

  appState.trade = {
    active: false,
    asset: null,
    durationDays: 0,
    startTime: null,
    tradeBalance: 0,
    returnsUSD: 0,
    percentageReturns: 0,
  };

  saveState();
  updateAppUI('home');
  updateViewEarningsUI();

  showModal('Trade Complete', `The automated trade has successfully completed. Earnings added to your Trade Balance and Total Earnings.`);
}

// --- Trade Page UI ---
function updateTradeUI() {
  document.getElementById('tradeBalance').textContent = formatCurrency(appState.balances.tradeUSD);
  document.getElementById('tradeReturns').textContent = formatCurrency(appState.trade.returnsUSD);
  document.getElementById('tradePercentage').textContent = `${appState.trade.percentageReturns.toFixed(2)}%`;

  const detailsEl = document.getElementById('activeTradeDetails');
  const statusEl = document.getElementById('tradeStatus');

  if (appState.trade.active) {
    detailsEl.classList.remove('hidden');
    statusEl.textContent = 'Trade Bot is Active';
    statusEl.classList.replace('text-yellow-400', 'text-green-400');
    document.getElementById('tradeAsset').textContent = appState.trade.asset.split(':')[1];
    document.getElementById('tradeDuration').textContent = `${appState.trade.durationDays} days`;
  } else {
    detailsEl.classList.add('hidden');
    statusEl.textContent = 'No active trade.';
    statusEl.classList.replace('text-green-400', 'text-yellow-400');
  }

  const totalEarningsValueEl = document.getElementById('totalEarningsValue');
  if (totalEarningsValueEl) totalEarningsValueEl.textContent = formatCurrency(appState.balances.tradeUSD);
}

// --- View Earnings Page UI (Live Updates) ---
function updateViewEarningsUI() {
  const totalEarnings = (appState.cumulativeEarnings || 0) + (appState.trade.returnsUSD || 0);
  const overallEarnings = (appState.trade.tradeBalance || 0) + (appState.trade.returnsUSD || 0);

  // Total Earnings Section
  const totalEarningsSectionEl = document.getElementById('totalEarningsSection');
  if (totalEarningsSectionEl) totalEarningsSectionEl.textContent = `Total Earnings: ${formatCurrency(totalEarnings)}`;

  // Total Percentage Returns Section
  const totalPercentageReturnsEl = document.getElementById('totalPercentageReturns');
  if (totalPercentageReturnsEl) totalPercentageReturnsEl.textContent = `${appState.trade.percentageReturns.toFixed(2)}%`;

  // Capital Section
  const capitalSectionEl = document.getElementById('capitalSection');
  if (capitalSectionEl) capitalSectionEl.textContent = `Capital Used: ${formatCurrency(appState.trade.tradeBalance)}`;

  // Returns Section
  const returnsSectionEl = document.getElementById('returnsSection');
  if (returnsSectionEl) returnsSectionEl.textContent = `Generated Returns: ${formatCurrency(appState.trade.returnsUSD)}`;

  // Overall Earnings Section
  const overallEarningsEl = document.getElementById('overallEarningsSection');
  if (overallEarningsEl) overallEarningsEl.textContent = `Overall Earnings: ${formatCurrency(overallEarnings)}`;

  // Sync charts
  initializeTradingViewChartOnce('tradeLiveChart', appState.trade.asset || 'BINANCE:BTCUSDT');
  initializeTradingViewChartOnce('earningsLiveChart', appState.trade.asset || 'BINANCE:BTCUSDT');

  // Reset Cumulative Earnings Button
  const resetBtn = document.getElementById('resetCumulativeEarningsBtn');
  if (resetBtn) {
    resetBtn.onclick = () => {
      appState.cumulativeEarnings = 0;
      saveState();
      updateViewEarningsUI();
      showModal('Cumulative Earnings Reset', 'The cumulative earnings have been cleared.');
    };
  }
}

// --- Projection Charts ---
function renderGrowthProjectionChart(canvasId, capital, durationDays, chartType, dailyRate = 0.0795) {
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;

  const maxPoints = 500;
  const step = Math.max(1, Math.floor((durationDays * 24 * 60 * 60) / maxPoints));
  const labels = Array.from({ length: maxPoints }, (_, i) => `Day ${(i * step) / (24 * 60 * 60)}`);
  const dataPoints = labels.map((_, i) => capital * Math.pow(1 + dailyRate, (i * step) / (24 * 60 * 60)));

  const currentPoint = Array(maxPoints).fill(null);
  currentPoint[currentPoint.length - 1] = dataPoints[dataPoints.length - 1];

  let chartRef = chartType === "trade" ? tradeProjectionChartInstance : earningsProjectionChartInstance;

  if (chartRef) {
    chartRef.data.datasets[0].data = dataPoints;
    chartRef.data.datasets[1].data = currentPoint;
    chartRef.update({ duration: 500, easing: 'linear' });
  } else {
    chartRef = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Projected Growth',
            data: dataPoints,
            borderColor: 'rgba(34,197,94,1)',
            backgroundColor: 'rgba(34,197,94,0.15)',
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0
          },
          {
            label: 'Current Position',
            data: currentPoint,
            borderColor: 'rgba(255,99,132,1)',
            backgroundColor: 'rgba(255,99,132,1)',
            pointRadius: 6,
            type: 'scatter'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 500, easing: 'linear' },
        scales: { y: { ticks: { callback: (val) => `$${val.toFixed(2)}` } } }
      }
    });
  }

  if (chartType === "trade") tradeProjectionChartInstance = chartRef;
  else earningsProjectionChartInstance = chartRef;
}

// --- Initialize TradingView Charts ONCE ---
function initializeTradingViewChartOnce(containerId, symbol) {
  if (!document.getElementById(containerId)) return;
  if (document.getElementById(containerId).dataset.initialized) return;

  new TradingView.widget({
    container_id: containerId,
    width: "100%",
    height: 350,
    symbol,
    interval: "1",
    timezone: "Etc/UTC",
    theme: "dark",
    style: "1",
    locale: "en",
    toolbar_bg: "#f1f3f6",
    enable_publishing: false,
    allow_symbol_change: true,
    hide_top_toolbar: false,
    hide_legend: false,
    save_image: false,
    studies: ["MASimple@tv-basicstudies"]
  });

  document.getElementById(containerId).dataset.initialized = true;
}

// --- Live Auto-Update (Background Sync) ---
setInterval(() => {
  if (appState.trade.active) {
    updateTradeUI();
    updateViewEarningsUI();
    renderGrowthProjectionChart("tradeProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "trade");
    renderGrowthProjectionChart("earningsProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "earnings");
  }
}, 1000);

// --- Transfer Modal ---
function showTransferModal() {
            document.getElementById('transferModal').classList.remove('hidden');
            // Default transfer amount to total earnings for ease of use
            document.getElementById('transferAmountInput').value = (appState.balances.tradeUSD + appState.trade.returnsUSD).toFixed(2);
        }

        function hideTransferModal() {
            document.getElementById('transferModal').classList.add('hidden');
        }

        async function handleTransfer() {
            const direction = document.getElementById('transferDirection').value;
            const amount = parseFloat(document.getElementById('transferAmountInput').value);

            if (isNaN(amount) || amount <= 0) {
                return showModal('Error', 'Please enter a valid amount.');
            }
            
            showLoading('Processing transaction...');
            await waitFor(15000);

            if (direction === 'tradeToMain') {
                // Trade to Main Wallet
                if (amount > appState.balances.tradeUSD + appState.trade.returnsUSD) {
                    hideLoading();
                    return showModal('Error', 'Insufficient funds in Trade Account.');
                }
                
                // Deduct from trade total balance (capital + returns)
                appState.balances.tradeUSD = (appState.balances.tradeUSD + appState.trade.returnsUSD) - amount;
                appState.trade.returnsUSD = 0; // Returns are absorbed into tradeUSD then transferred
                appState.balances.totalUSD += amount;
                appState.balances.usdtBalance += amount;
                
                appState.activities.push({
                    type: 'Transfer',
                    message: `Transferred ${formatCurrency(amount)} from Trade Account to Main Wallet.`,
                    timestamp: Date.now(),
                });

            } else {
                // Main Wallet to Trade Account
                if (amount > appState.balances.totalUSD) {
                    hideLoading();
                    return showModal('Error', 'Insufficient funds in Main Wallet.');
                }
                
                appState.balances.totalUSD -= amount;
                appState.balances.usdtBalance -= amount;
                appState.balances.tradeUSD += amount;
                
                appState.activities.push({
                    type: 'Transfer',
                    message: `Transferred ${formatCurrency(amount)} from Main Wallet to Trade Account.`,
                    timestamp: Date.now(),
                });
            }

            saveState();
            hideLoading();
            hideTransferModal();
            updateAppUI('home');
            showModal('Transaction Complete', `Transfer of ${formatCurrency(amount)} was successful.`);
        }
        
        function showTradeDepositSelect() {
            // Placeholder for Deposit/Transfer buttons on Trade page
            const container = document.getElementById('tradePage');
            
            const depositAction = document.createElement('div');
            depositAction.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-end" id="tradeDepositModal">
                    <div class="w-full bg-gray-900 rounded-t-xl p-6 border-t border-gray-700">
                        <h3 class="text-xl font-bold mb-4">Fund Trade Account</h3>
                        <div class="space-y-3">
                            <button class="w-full text-left p-4 bg-yellow-500 text-black rounded-lg hover:bg-yellow-600 transition-colors font-semibold" onclick="hideTradeDepositModal(); showPage('depositPage');">
                                Deposit New Asset
                            </button>
                            <button class="w-full text-left p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors" onclick="hideTradeDepositModal(); showTransferModal(); document.getElementById('transferDirection').value = 'mainToTrade'">
                                Transfer from Main Wallet
                            </button>
                        </div>
                        <button class="w-full mt-4 px-4 py-2 bg-gray-700 text-white rounded-md font-semibold hover:bg-gray-600" onclick="hideTradeDepositModal()">Cancel</button>
                    </div>
                </div>
            `;
            container.appendChild(depositAction);
        }

        function hideTradeDepositModal() {
            const modal = document.getElementById('tradeDepositModal');
            if (modal) modal.remove();
        }

        // =======================================================
        // 9. COUNTDOWN LOGIC (Withdrawal & Trade)
        // =======================================================

        function startWithdrawalCountdown() {
            clearInterval(countdownInterval); // Clear any existing interval
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function updateCountdown() {
            const now = Date.now();
            let shouldUpdateUI = false;

            // --- Withdrawal Countdown ---
            if (appState.withdrawal.active && appState.withdrawal.targetTime) {
                const remainingMs = appState.withdrawal.targetTime - now;

                if (remainingMs <= 0) {
                    // Withdrawal Success
                    appState.balances.totalUSD -= appState.withdrawal.amount;
                    appState.balances.usdtBalance -= appState.withdrawal.amount;
                    appState.withdrawal.active = false;
                    appState.activities.push({
                        type: 'Withdrawal Success',
                        message: `Withdrawal of ${appState.withdrawal.amount.toFixed(2)} USDT completed successfully.`,
                        timestamp: Date.now(),
                    });
                    
                    saveState();
                    clearInterval(countdownInterval);
                    updateAppUI('home');
                    showModal('Withdrawal Complete', `Your withdrawal of ${appState.withdrawal.amount.toFixed(2)} USDT has been successful!`);
                    
                } else {
                    const totalSecs = Math.floor(remainingMs / 1000);
                    const hours = Math.floor(totalSecs / 3600);
                    const minutes = Math.floor((totalSecs % 3600) / 60);
                    const seconds = totalSecs % 60;
                    
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    const countdownEl = document.getElementById('withdrawalCountdown');
                    if (countdownEl) countdownEl.textContent = timeString;
                    
                    // Update activity list entry
                    const activity = appState.activities.find(a => a.type === 'Withdrawal' && a.countdownTarget);
                    if (activity) activity.message = `Withdrawal of ${appState.withdrawal.amount.toFixed(2)} USDT processing. Remaining: ${timeString}.`;
                    
                    shouldUpdateUI = true;
                }
            }

// --- Trade Countdown & Live Returns ---
function updateTradeCountdown() {
    if (appState.trade.active && appState.trade.startTime) {
        const now = Date.now();
        const totalDurationMs = appState.trade.durationDays * 24 * 60 * 60 * 1000;
        const endTime = appState.trade.startTime + totalDurationMs;
        const remainingMs = endTime - now;

        if (remainingMs <= 0) {  
            // Trade has ended
            handleTradeEnd();  
        } else {  
            // Calculate remaining time
            const totalSecs = Math.floor(remainingMs / 1000);  
            const days = Math.floor(totalSecs / (3600 * 24));  
            const hours = Math.floor((totalSecs % (3600 * 24)) / 3600);  
            const minutes = Math.floor((totalSecs % 3600) / 60);  
            const seconds = totalSecs % 60;  

            const timeString = `${days}d ${hours}h ${minutes}m ${seconds}s`;  

            // Update countdown in Trade Page
            const tradeCountdownEl = document.getElementById('tradeCountdown');  
            if (tradeCountdownEl) tradeCountdownEl.textContent = timeString;  
            const tradeCountdownActiveEl = document.getElementById('tradeCountdownActive');
            if (tradeCountdownActiveEl) tradeCountdownActiveEl.textContent = timeString;

            // --- Generate returns per second ---
            const dailyRate = 0.0795; // 7.95% daily
            const returnPerSecond = (appState.trade.tradeBalance * dailyRate) / (24 * 60 * 60);
            appState.trade.returnsUSD += returnPerSecond;
            appState.trade.percentageReturns = (appState.trade.returnsUSD / appState.trade.tradeBalance) * 100;

            // Include returns in trade balance
            appState.balances.tradeUSD += returnPerSecond;

            // Update UI & Charts
            updateTradeUI();
            updateViewEarningsUI();
            renderGrowthProjectionChart("tradeProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "trade");
            renderGrowthProjectionChart("earningsProjectionChart", appState.balances.tradeUSD, appState.trade.durationDays, "earnings");
            renderActivities(); // Optional: logs or activity feed
        }  
    }
}

// Run countdown updater every second
setInterval(updateTradeCountdown, 1000);

 }

    // =======================================================
        // 10. ACTIVITY AND NOTIFICATION RENDERING
        // =======================================================

        function renderActivities() {
            const listContainer = document.getElementById('activityList');
            const fullListContainer = document.getElementById('fullActivityList');

            if (!listContainer || !fullListContainer) return;

            // Sort by timestamp descending
            const sortedActivities = [...appState.activities].sort((a, b) => b.timestamp - a.timestamp);

            const renderActivity = (activity) => {
                let color = 'text-gray-300';
                if (activity.type.includes('Success')) color = 'text-green-400';
                if (activity.type.includes('Withdrawal')) color = 'text-red-400';
                if (activity.type.includes('Deposit')) color = 'text-green-400';
                if (activity.type.includes('Transfer')) color = 'text-blue-400';
                if (activity.type.includes('Suspension')) color = 'text-red-600 font-bold';

                const date = new Date(activity.timestamp).toLocaleDateString();
                return `
                    <div class="p-2 border-b border-gray-700 last:border-b-0">
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-medium ${color}">${activity.type}</span>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-xs text-gray-400">${activity.message}</p>
                    </div>
                `;
            };

            if (sortedActivities.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500">No recent activities.</div>';
                fullListContainer.innerHTML = '<div class="text-gray-500">All confirmed transactions and ongoing activities will appear here.</div>';
            } else {
                // Home list (top 5)
                listContainer.innerHTML = sortedActivities.slice(0, 5).map(renderActivity).join('');
                // Full list
                fullListContainer.innerHTML = sortedActivities.map(renderActivity).join('');
            }
        }

        function toggleNotifications() {
            appState.settings.notificationsOn = document.getElementById('notificationToggle').checked;
            saveState();
            showModal('Notifications', `Daily Market Notifications are now ${appState.settings.notificationsOn ? 'ON' : 'OFF'}.`);
        }
        
        function showNotificationPopup(message) {
            document.getElementById('notifMessage').textContent = message;
            document.getElementById('dailyNotification').classList.remove('hidden');
            // Hide after 10 seconds
            setTimeout(hideNotification, 10000);
        }

        async function loadDailyMarketUpdates() {
            if (!appState.isLoggedIn || !appState.settings.notificationsOn) return;

            const now = Date.now();
            const lastTime = appState.settings.lastNotificationTime || 0;
            const twelveHours = 12 * 60 * 60 * 1000;

            // Check if 12 hours have passed since last notification
            if (now - lastTime < twelveHours) return;

            try {
                const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=3&page=1&sparkline=false`);
                if (!response.ok) throw new Error('Failed to fetch market data');
                const coins = await response.json();
                
                const btc = coins.find(c => c.symbol === 'btc');
                const eth = coins.find(c => c.symbol === 'eth');

                if (btc && eth) {
                    const message = `Market Update: BTC ${btc.price_change_percentage_24h > 0 ? 'UP' : 'DOWN'} ${btc.price_change_percentage_24h.toFixed(2)}%. ETH ${eth.price_change_percentage_24h > 0 ? 'UP' : 'DOWN'} ${eth.price_change_percentage_24h.toFixed(2)}%. Stay informed!`;
                    
                    appState.activities.push({
                        type: 'Market Alert',
                        message: message,
                        timestamp: now,
                    });
                    
                    showNotificationPopup(message);
                    appState.settings.lastNotificationTime = now;
                    saveState();
                    renderNotifications();
                }
            } catch (error) {
                console.warn("Could not fetch daily market updates:", error);
            }
        }
        
        function renderNotifications() {
            const notifList = document.getElementById('notificationList');
            const sortedNotifs = [...appState.activities].filter(a => a.type.includes('Alert') || a.type.includes('Success') || a.type.includes('Suspension')).sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedNotifs.length === 0) {
                notifList.innerHTML = '<div class="text-gray-500">No new notifications.</div>';
                return;
            }

            notifList.innerHTML = sortedNotifs.map(n => {
                const color = n.type.includes('Alert') ? 'text-yellow-400' : (n.type.includes('Success') ? 'text-green-400' : 'text-red-400');
                const date = new Date(n.timestamp).toLocaleTimeString();
                return `
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-semibold ${color}">${n.type}</span>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-sm text-gray-300 mt-1">${n.message}</p>
                    </div>
                `;
            }).join('');
        }

        // =======================================================
        // 11. GOOGLE AUTH & MISC
        // =======================================================

        function generateGoogleAuthSetup() {
            // Generate a simulated unique secret key for the user
            if (!appState.settings.googleAuthSecret) {
                // Mock Secret Key - In a real app, this is server-generated
                const secret = Array(16).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567'.charAt(Math.floor(Math.random() * 32))).join('');
                appState.settings.googleAuthSecret = secret;
                saveState();
            }
            
            const secret = appState.settings.googleAuthSecret;
            const issuer = 'AITradingBot';
            const account = appState.userId;
            const otpAuthURL = `otpauth://totp/${issuer}:${account}?secret=${secret}&issuer=${issuer}`;

            document.getElementById('authAccountId').textContent = appState.userId;
            document.getElementById('authSecretKey').textContent = secret;
            
            // Clear previous QR and generate new one
            document.getElementById('authQRCode').innerHTML = '';
            new QRCode(document.getElementById('authQRCode'), {
                text: otpAuthURL,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        async function handleGoogleAuthVerification() {
            const code = document.getElementById('authCodeInput').value.trim();
            if (code.length !== 6) {
                return showModal('Error', 'Please enter a 6-digit code.');
            }
            
            showLoading('Verifying code...');
            await waitFor(15000);

            // Simulate code verification success
            if (code === '123456' || code === '000000') { // Use fixed test codes for simulation
                appState.settings.isAuthVerified = true;
                saveState();
                hideLoading();
                showModal('Verification Success', 'Google Authenticator has been successfully linked to your account!');
                showPage('accountDetailsPage');
            } else {
                hideLoading();
                showModal('Verification Failed', 'Incorrect code entered. Please try again.');
            }
        }

        function handleSaveAccountDetails() {
            showModal('Details Saved', 'Account details saved to local memory.');
        }
        
        // =======================================================
        // 12. GEMINI CHATBOT LOGIC (LLM)
        // =======================================================

        async function handleChatSend() {
            const inputEl = document.getElementById('chatInput');
            const chatWindow = document.getElementById('chatWindow');
            const userMessage = inputEl.value.trim();

            if (!userMessage) return;

            // 1. Display User Message
            chatWindow.innerHTML += `
                <div class="flex justify-end">
                    <div class="bg-blue-600 p-3 rounded-xl max-w-xs">${userMessage}</div>
                </div>
            `;
            inputEl.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // 2. Display Loading for AI
            const loadingHtml = `
                <div class="flex justify-start" id="aiLoading">
                    <div class="bg-gray-700 p-3 rounded-xl max-w-xs">AI Bot is typing...</div>
                </div>
            `;
            chatWindow.innerHTML += loadingHtml;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // 3. Construct API Payload
            const systemPrompt = "You are a friendly, knowledgeable, and professional AI Support Bot for the 'Blockchain Auto-Trading Bot'. Your purpose is to assist users and help them understand trading with the bot. Keep responses concise and focused.";
            const userQuery = userMessage;
            const apiKey = ""; // Canvas will inject the key

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = GEMINI_API_URL + apiKey;

            let aiResponseText = "Sorry, I am currently unable to connect to the support service.";
            
            // 4. API Call with Exponential Backoff
            const MAX_RETRIES = 5;
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) throw new Error('Rate limit exceeded (429)');
                        throw new Error(`API error: ${response.status}`);
                    }

                    const result = await response.json();
                    aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || aiResponseText;
                    break; // Success, exit loop

                } catch (error) {
                    console.error(`Gemini API call failed (Attempt ${attempt + 1}):`, error.message);
                    if (attempt === MAX_RETRIES - 1) {
                        break; // Failed all attempts
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // 5. Display AI Response
            const aiLoadingEl = document.getElementById('aiLoading');
            if (aiLoadingEl) aiLoadingEl.remove();

            chatWindow.innerHTML += `
                <div class="flex justify-start">
                    <div class="bg-gray-700 p-3 rounded-xl max-w-xs">
                        <span class="font-semibold text-yellow-500">AI Bot:</span> ${aiResponseText}
                    </div>
                </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // =======================================================  
// 13. INITIALIZATION & EVENT LISTENERS  
// =======================================================  

function closeMoreMenu() {  
    const menu = document.getElementById('moreMenu');
    if (menu) menu.classList.add('hidden');  
}  

function closeLandingMoreMenu() {  
    const menu = document.getElementById('landingMoreMenu');
    if (menu) menu.classList.add('hidden');  
}  

window.addEventListener('load', function() {  
    loadState();  
    registerPWA();  
    setupInstallPrompt();  

    // Re-check for ongoing countdowns and suspension on every load  
    if (appState.withdrawal?.active && appState.withdrawal?.targetTime) {  
        startWithdrawalCountdown();  
    }  
    if (appState.trade?.active) {  
        startTradeCountdown();  
    }  

    // Always show landingPage if not logged in  
    if (appState.isLoggedIn) {  
        const initialPage = (appState.currentPage === 'landingPage') ? 'home' : appState.currentPage;  
        showPage(initialPage, true);  
        fetchMarketData();  
        initializeTradingViewChart('tvchart', 'BINANCE:BTCUSDT');  
        loadDailyMarketUpdates();  
        loadDepositCoins();  
    } else {  
        showPage('landingPage', true);  
        fetchMarketData();  
    }  

    // Global Event Listeners  
    document.querySelectorAll('.nav-tab').forEach(button => {  
        button.addEventListener('click', (e) => {  
            const pageId = e.currentTarget.dataset.page;  
            showPage(pageId);  
        });  
    });  

    const moreBtn = document.getElementById('moreBtn');  
    if (moreBtn) moreBtn.addEventListener('click', (e) => {  
        const menu = document.getElementById('moreMenu');  
        if (menu) menu.classList.toggle('hidden');  
        e.stopPropagation();  
    });  

    const landingMoreBtn = document.getElementById('landingMoreBtn');  
    if (landingMoreBtn) landingMoreBtn.addEventListener('click', (e) => {  
        const menu = document.getElementById('landingMoreMenu');  
        if (menu) menu.classList.toggle('hidden');  
        e.stopPropagation();  
    });  

    // Notification toggle  
    const notifToggle = document.getElementById('notificationToggle');  
    if (notifToggle) notifToggle.checked = appState.settings.notificationsOn;  

    // Google Auth setup  
    const googleAuthPage = document.getElementById('googleAuthPage');  
    if (googleAuthPage) generateGoogleAuthSetup();  

    // Close menus when clicking elsewhere  
    document.addEventListener('click', (e) => {  
        if (!e.target.closest('#moreBtn')) closeMoreMenu();  
        if (!e.target.closest('#landingMoreBtn')) closeLandingMoreMenu();  
    });  

    // Initialize trade chart if on trade page  
    if (appState.isLoggedIn && appState.currentPage === 'tradePage') {  
        const tradePage = document.getElementById('tradePage');  
        if (tradePage) initializeTradingViewChart('tradeTvchart', appState.trade.asset || 'BINANCE:BTCUSDT');  
    }  
});  

function startTradeCountdown() {  
    if (!countdownInterval) {  
        countdownInterval = setInterval(updateCountdown, 1000);  
    }  
}
</script>
</body>
</html>
